--!strict
-- RealtimeBattleController
-- ì‹¤ì‹œê°„ ë°°í‹€: ëŒ€ê¸° UI + ê²Œì„ ì¤‘ ìƒëŒ€ ì ìˆ˜ HUD + ê²°ê³¼ ì˜¤ë²„ë ˆì´

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")

local RemoteEvents = require(ReplicatedStorage.Shared.RemoteEvents)
local ResponsiveUtil = require(ReplicatedStorage.Shared.Utils.ResponsiveUtil)

local RealtimeBattleController = {}
RealtimeBattleController.__index = RealtimeBattleController

export type RealtimeBattleController = typeof(setmetatable(
	{} :: {
		_player: Player,
		_connections: { RBXScriptConnection },
		-- ëŒ€ê¸° í™”ë©´
		_queueGui: ScreenGui?,
		_queueTimerLabel: TextLabel?,
		_queueTask: thread?,
		-- ê²Œì„ ì¤‘ HUD
		_hudGui: ScreenGui?,
		_opponentNameLabel: TextLabel?,
		_opponentScoreLabel: TextLabel?,
		-- ê²°ê³¼ ì˜¤ë²„ë ˆì´
		_resultGui: ScreenGui?,
		-- ë¡œë¹„ ë²„íŠ¼ GUI
		_lobbyGui: ScreenGui?,
		-- í˜„ì¬ ìƒíƒœ
		_isQueuing: boolean,
		_isInBattle: boolean,
		_currentOpponentName: string?,
	},
	RealtimeBattleController
))

function RealtimeBattleController.new(player: Player): RealtimeBattleController
	local self = setmetatable({
		_player = player,
		_connections = {},
		_queueGui = nil,
		_queueTimerLabel = nil,
		_queueTask = nil,
		_hudGui = nil,
		_opponentNameLabel = nil,
		_opponentScoreLabel = nil,
		_resultGui = nil,
		_lobbyGui = nil,
		_isQueuing = false,
		_isInBattle = false,
		_currentOpponentName = nil,
	}, RealtimeBattleController)

	self:_createGui()
	self:_setupEventHandlers()

	return self
end

-- ==================== GUI ìƒì„± ====================

function RealtimeBattleController:_createGui()
	local playerGui = self._player:WaitForChild("PlayerGui")

	-- â”€â”€ ëŒ€ê¸° í™”ë©´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
	local queueGui = Instance.new("ScreenGui")
	queueGui.Name = "BattleQueueGui"
	queueGui.ResetOnSpawn = false
	queueGui.DisplayOrder = 22
	queueGui.Enabled = false
	queueGui.Parent = playerGui
	self._queueGui = queueGui

	local queueDim = Instance.new("Frame")
	queueDim.Size = UDim2.new(1, 0, 1, 0)
	queueDim.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
	queueDim.BackgroundTransparency = 0.5
	queueDim.BorderSizePixel = 0
	queueDim.Parent = queueGui

	local queuePanel = Instance.new("Frame")
	queuePanel.Size = UDim2.new(0, 300, 0, 180)
	queuePanel.Position = UDim2.new(0.5, -150, 0.38, 0)
	queuePanel.BackgroundColor3 = Color3.fromRGB(15, 20, 50)
	queuePanel.BorderSizePixel = 0
	queuePanel.Parent = queueGui

	local queueCorner = Instance.new("UICorner")
	queueCorner.CornerRadius = UDim.new(0, 14)
	queueCorner.Parent = queuePanel

	local queueStroke = Instance.new("UIStroke")
	queueStroke.Color = Color3.fromRGB(100, 150, 255)
	queueStroke.Thickness = 2
	queueStroke.Parent = queuePanel

	local queueTitle = Instance.new("TextLabel")
	queueTitle.Size = UDim2.new(1, 0, 0, 50)
	queueTitle.BackgroundTransparency = 1
	queueTitle.TextColor3 = Color3.fromRGB(100, 180, 255)
	queueTitle.TextSize = ResponsiveUtil.scaledTextSize(20, 16)
	queueTitle.Font = Enum.Font.GothamBlack
	queueTitle.Text = "âš”ï¸ ì‹¤ì‹œê°„ ë°°í‹€"
	queueTitle.Parent = queuePanel

	local queueStatus = Instance.new("TextLabel")
	queueStatus.Size = UDim2.new(1, 0, 0, 30)
	queueStatus.Position = UDim2.new(0, 0, 0, 50)
	queueStatus.BackgroundTransparency = 1
	queueStatus.TextColor3 = Color3.fromRGB(200, 200, 220)
	queueStatus.TextSize = 14
	queueStatus.Font = Enum.Font.Gotham
	queueStatus.Text = "ìƒëŒ€ë¥¼ ì°¾ëŠ” ì¤‘..."
	queueStatus.Parent = queuePanel

	local queueTimer = Instance.new("TextLabel")
	queueTimer.Name = "Timer"
	queueTimer.Size = UDim2.new(1, 0, 0, 36)
	queueTimer.Position = UDim2.new(0, 0, 0, 82)
	queueTimer.BackgroundTransparency = 1
	queueTimer.TextColor3 = Color3.fromRGB(255, 215, 0)
	queueTimer.TextSize = 28
	queueTimer.Font = Enum.Font.GothamBold
	queueTimer.Text = "12"
	queueTimer.Parent = queuePanel
	self._queueTimerLabel = queueTimer

	local cancelBtn = Instance.new("TextButton")
	cancelBtn.Size = UDim2.new(0, 140, 0, 36)
	cancelBtn.Position = UDim2.new(0.5, -70, 0, 130)
	cancelBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 100)
	cancelBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
	cancelBtn.TextSize = 14
	cancelBtn.Font = Enum.Font.GothamBold
	cancelBtn.Text = "ì·¨ì†Œ"
	cancelBtn.Parent = queuePanel

	local cancelBtnCorner = Instance.new("UICorner")
	cancelBtnCorner.CornerRadius = UDim.new(0, 8)
	cancelBtnCorner.Parent = cancelBtn

	cancelBtn.MouseButton1Click:Connect(function()
		self:_leaveQueue()
	end)

	-- â”€â”€ ê²Œì„ ì¤‘ HUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
	local hudGui = Instance.new("ScreenGui")
	hudGui.Name = "BattleHud"
	hudGui.ResetOnSpawn = false
	hudGui.DisplayOrder = 21
	hudGui.Enabled = false
	hudGui.Parent = playerGui
	self._hudGui = hudGui

	local hudFrame = Instance.new("Frame")
	hudFrame.Size = UDim2.new(0, 200, 0, 56)
	hudFrame.Position = UDim2.new(0, 10, 0.5, -28)
	hudFrame.BackgroundColor3 = Color3.fromRGB(20, 15, 50)
	hudFrame.BackgroundTransparency = 0.15
	hudFrame.BorderSizePixel = 0
	hudFrame.Parent = hudGui

	local hudCorner = Instance.new("UICorner")
	hudCorner.CornerRadius = UDim.new(0, 10)
	hudCorner.Parent = hudFrame

	local hudStroke = Instance.new("UIStroke")
	hudStroke.Color = Color3.fromRGB(100, 150, 255)
	hudStroke.Thickness = 2
	hudStroke.Parent = hudFrame

	local hudVsLabel = Instance.new("TextLabel")
	hudVsLabel.Size = UDim2.new(1, -8, 0, 22)
	hudVsLabel.Position = UDim2.new(0, 4, 0, 4)
	hudVsLabel.BackgroundTransparency = 1
	hudVsLabel.TextColor3 = Color3.fromRGB(150, 180, 255)
	hudVsLabel.TextSize = 11
	hudVsLabel.Font = Enum.Font.GothamBold
	hudVsLabel.Text = "âš”ï¸ VS"
	hudVsLabel.TextXAlignment = Enum.TextXAlignment.Left
	hudVsLabel.Parent = hudFrame

	local opponentNameLabel = Instance.new("TextLabel")
	opponentNameLabel.Name = "OpponentName"
	opponentNameLabel.Size = UDim2.new(1, -8, 0, 16)
	opponentNameLabel.Position = UDim2.new(0, 4, 0, 22)
	opponentNameLabel.BackgroundTransparency = 1
	opponentNameLabel.TextColor3 = Color3.fromRGB(200, 210, 255)
	opponentNameLabel.TextSize = 11
	opponentNameLabel.Font = Enum.Font.Gotham
	opponentNameLabel.Text = "---"
	opponentNameLabel.TextXAlignment = Enum.TextXAlignment.Left
	opponentNameLabel.TextTruncate = Enum.TextTruncate.AtEnd
	opponentNameLabel.Parent = hudFrame
	self._opponentNameLabel = opponentNameLabel

	local opponentScoreLabel = Instance.new("TextLabel")
	opponentScoreLabel.Name = "OpponentScore"
	opponentScoreLabel.Size = UDim2.new(1, -8, 0, 18)
	opponentScoreLabel.Position = UDim2.new(0, 4, 0, 36)
	opponentScoreLabel.BackgroundTransparency = 1
	opponentScoreLabel.TextColor3 = Color3.fromRGB(255, 215, 0)
	opponentScoreLabel.TextSize = 16
	opponentScoreLabel.Font = Enum.Font.GothamBold
	opponentScoreLabel.Text = "0ì "
	opponentScoreLabel.TextXAlignment = Enum.TextXAlignment.Left
	opponentScoreLabel.Parent = hudFrame
	self._opponentScoreLabel = opponentScoreLabel

	-- â”€â”€ ê²°ê³¼ ì˜¤ë²„ë ˆì´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
	local resultGui = Instance.new("ScreenGui")
	resultGui.Name = "BattleResultGui"
	resultGui.ResetOnSpawn = false
	resultGui.DisplayOrder = 26
	resultGui.Enabled = false
	resultGui.Parent = playerGui
	self._resultGui = resultGui

	local resultDim = Instance.new("Frame")
	resultDim.Size = UDim2.new(1, 0, 1, 0)
	resultDim.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
	resultDim.BackgroundTransparency = 0.45
	resultDim.BorderSizePixel = 0
	resultDim.Parent = resultGui

	local resultFrame = Instance.new("Frame")
	resultFrame.Name = "ResultFrame"
	resultFrame.Size = UDim2.new(0, 360, 0, 230)
	resultFrame.Position = UDim2.new(0.5, -180, 0.33, 0)
	resultFrame.BackgroundColor3 = Color3.fromRGB(15, 20, 50)
	resultFrame.BorderSizePixel = 0
	resultFrame.Parent = resultGui

	local resultCorner = Instance.new("UICorner")
	resultCorner.CornerRadius = UDim.new(0, 14)
	resultCorner.Parent = resultFrame

	local resultStroke = Instance.new("UIStroke")
	resultStroke.Name = "ResultStroke"
	resultStroke.Color = Color3.fromRGB(100, 150, 255)
	resultStroke.Thickness = 2.5
	resultStroke.Parent = resultFrame

	local resultTitle = Instance.new("TextLabel")
	resultTitle.Name = "ResultTitle"
	resultTitle.Size = UDim2.new(1, 0, 0, 68)
	resultTitle.BackgroundTransparency = 1
	resultTitle.TextColor3 = Color3.fromRGB(255, 215, 0)
	resultTitle.TextSize = 36
	resultTitle.Font = Enum.Font.GothamBlack
	resultTitle.Text = "ğŸ† ìŠ¹ë¦¬!"
	resultTitle.Parent = resultFrame

	local resultDetail = Instance.new("TextLabel")
	resultDetail.Name = "ResultDetail"
	resultDetail.Size = UDim2.new(1, -20, 0, 60)
	resultDetail.Position = UDim2.new(0, 10, 0, 72)
	resultDetail.BackgroundTransparency = 1
	resultDetail.TextColor3 = Color3.fromRGB(200, 200, 220)
	resultDetail.TextSize = 15
	resultDetail.Font = Enum.Font.Gotham
	resultDetail.TextWrapped = true
	resultDetail.Text = ""
	resultDetail.Parent = resultFrame

	local resultReward = Instance.new("TextLabel")
	resultReward.Name = "ResultReward"
	resultReward.Size = UDim2.new(1, 0, 0, 36)
	resultReward.Position = UDim2.new(0, 0, 0, 135)
	resultReward.BackgroundTransparency = 1
	resultReward.TextColor3 = Color3.fromRGB(80, 220, 100)
	resultReward.TextSize = 20
	resultReward.Font = Enum.Font.GothamBold
	resultReward.Text = ""
	resultReward.Parent = resultFrame

	local closeBtn = Instance.new("TextButton")
	closeBtn.Size = UDim2.new(0, 180, 0, 36)
	closeBtn.Position = UDim2.new(0.5, -90, 0, 180)
	closeBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 100)
	closeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
	closeBtn.TextSize = 14
	closeBtn.Font = Enum.Font.GothamBold
	closeBtn.Text = "ë‹«ê¸°"
	closeBtn.Parent = resultFrame

	local closeBtnCorner = Instance.new("UICorner")
	closeBtnCorner.CornerRadius = UDim.new(0, 8)
	closeBtnCorner.Parent = closeBtn

	closeBtn.MouseButton1Click:Connect(function()
		resultGui.Enabled = false
	end)

	-- â”€â”€ ë¡œë¹„ ë²„íŠ¼ (âš”ï¸ ë°°í‹€) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
	local lobbyGui = Instance.new("ScreenGui")
	lobbyGui.Name = "BattleLobbyButton"
	lobbyGui.ResetOnSpawn = false
	lobbyGui.DisplayOrder = 12
	lobbyGui.Enabled = false
	lobbyGui.Parent = playerGui
	self._lobbyGui = lobbyGui

	local battleBtn = Instance.new("TextButton")
	battleBtn.Name = "BattleButton"
	battleBtn.Size = UDim2.new(0, 52, 0, 52)
	battleBtn.Position = UDim2.new(1, -64, 0, 182)
	battleBtn.BackgroundColor3 = Color3.fromRGB(20, 30, 80)
	battleBtn.TextColor3 = Color3.fromRGB(100, 170, 255)
	battleBtn.TextSize = 26
	battleBtn.Font = Enum.Font.GothamBold
	battleBtn.Text = "âš”ï¸"
	battleBtn.Parent = lobbyGui

	local battleBtnCorner = Instance.new("UICorner")
	battleBtnCorner.CornerRadius = UDim.new(0, 12)
	battleBtnCorner.Parent = battleBtn

	local battleBtnStroke = Instance.new("UIStroke")
	battleBtnStroke.Color = Color3.fromRGB(100, 150, 255)
	battleBtnStroke.Thickness = 2
	battleBtnStroke.Parent = battleBtn

	battleBtn.MouseButton1Click:Connect(function()
		self:_enterQueue()
	end)
end

-- ==================== ì´ë²¤íŠ¸ ====================

function RealtimeBattleController:_setupEventHandlers()
	-- ë§¤ì¹­ ì™„ë£Œ
	local matchConn = RemoteEvents.BattleMatchFound.OnClientEvent:Connect(function(data)
		self:_onMatchFound(data)
	end)
	table.insert(self._connections, matchConn)

	-- ìƒëŒ€ ì ìˆ˜ ì—…ë°ì´íŠ¸
	local scoreConn = RemoteEvents.BattleOpponentScore.OnClientEvent:Connect(function(data)
		if self._isInBattle and self._opponentScoreLabel then
			self._opponentScoreLabel.Text = `{data.score}ì `
		end
	end)
	table.insert(self._connections, scoreConn)

	-- ë°°í‹€ ê²°ê³¼
	local resultConn = RemoteEvents.BattleResult.OnClientEvent:Connect(function(data)
		self:_showResult(data)
	end)
	table.insert(self._connections, resultConn)
end

-- ==================== í ê´€ë¦¬ ====================

function RealtimeBattleController:_enterQueue()
	if self._isQueuing or self._isInBattle then
		return
	end
	self._isQueuing = true

	-- ëŒ€ê¸° í™”ë©´ í‘œì‹œ
	if self._queueGui then
		self._queueGui.Enabled = true
	end

	-- íƒ€ì´ë¨¸ ì¹´ìš´íŠ¸ë‹¤ìš´
	local remaining = 12
	self._queueTask = task.spawn(function()
		while remaining > 0 and self._isQueuing do
			if self._queueTimerLabel then
				self._queueTimerLabel.Text = tostring(remaining)
			end
			task.wait(1)
			remaining -= 1
		end
	end)

	RemoteEvents.BattleQueueEnter:FireServer()
end

function RealtimeBattleController:_leaveQueue()
	if not self._isQueuing then
		return
	end
	self._isQueuing = false

	if self._queueGui then
		self._queueGui.Enabled = false
	end

	RemoteEvents.BattleQueueLeave:FireServer()
end

function RealtimeBattleController:_onMatchFound(data: any)
	self._isQueuing = false
	self._isInBattle = true
	self._currentOpponentName = data.opponentName

	-- ëŒ€ê¸° í™”ë©´ ë‹«ê¸°
	if self._queueGui then
		self._queueGui.Enabled = false
	end

	-- ìƒëŒ€ ì •ë³´ ì„¤ì •
	if self._opponentNameLabel then
		local tag = data.isBot and " ğŸ¤–" or ""
		self._opponentNameLabel.Text = `{data.opponentName}{tag}`
	end
	if self._opponentScoreLabel then
		self._opponentScoreLabel.Text = "0ì "
	end

	print(`[RealtimeBattleController] Match found: vs {data.opponentName} (bot: {data.isBot})`)
end

-- ==================== ê²Œì„ í™œì„±í™” ====================

function RealtimeBattleController:SetGameActive(active: boolean)
	if active and self._isInBattle then
		-- ê²Œì„ ì‹œì‘: HUD í‘œì‹œ
		if self._hudGui then
			self._hudGui.Enabled = true
		end
	elseif not active then
		-- ê²Œì„ ì¢…ë£Œ: HUD ìˆ¨ê¸°ê¸°
		if self._hudGui then
			self._hudGui.Enabled = false
		end
		self._isInBattle = false
	end
end

-- ==================== ë¡œë¹„ í‘œì‹œ/ìˆ¨ê¸°ê¸° ====================

function RealtimeBattleController:ShowInLobby()
	if self._lobbyGui then
		self._lobbyGui.Enabled = true
	end
end

function RealtimeBattleController:HideForGame()
	if self._lobbyGui then
		self._lobbyGui.Enabled = false
	end
	-- íì— ìˆì—ˆìœ¼ë©´ ì·¨ì†Œ
	if self._isQueuing then
		self:_leaveQueue()
	end
end

-- ==================== ê²°ê³¼ í‘œì‹œ ====================

function RealtimeBattleController:_showResult(data: any)
	local resultGui = self._resultGui
	if not resultGui then
		return
	end

	local resultFrame = resultGui:FindFirstChild("ResultFrame") :: Frame?
	if not resultFrame then
		return
	end

	local titleLbl = resultFrame:FindFirstChild("ResultTitle") :: TextLabel?
	local detailLbl = resultFrame:FindFirstChild("ResultDetail") :: TextLabel?
	local rewardLbl = resultFrame:FindFirstChild("ResultReward") :: TextLabel?
	local stroke = resultFrame:FindFirstChild("ResultStroke") :: UIStroke?

	if data.won then
		if titleLbl then
			titleLbl.Text = "ğŸ† ìŠ¹ë¦¬!"
			titleLbl.TextColor3 = Color3.fromRGB(255, 215, 0)
		end
		if stroke then
			stroke.Color = Color3.fromRGB(255, 215, 0)
		end
		if detailLbl then
			detailLbl.Text = `{data.opponentName}ë¥¼ ì´ê²¼ì–´ìš”!\në‚´ ì ìˆ˜: {data.myScore}ì  vs ìƒëŒ€: {data.opponentScore}ì `
		end
		if rewardLbl then
			if data.reward and data.reward > 0 then
				rewardLbl.Text = `ğŸ’ +{data.reward} ì ¬ íšë“!`
			else
				rewardLbl.Text = ""
			end
		end
	else
		if titleLbl then
			titleLbl.Text = "ğŸ’ª ì•„ê¹ë‹¤!"
			titleLbl.TextColor3 = Color3.fromRGB(150, 150, 255)
		end
		if stroke then
			stroke.Color = Color3.fromRGB(150, 150, 255)
		end
		if detailLbl then
			detailLbl.Text = `{data.opponentName}ì—ê²Œ ì¡Œì–´ìš”.\në‚´ ì ìˆ˜: {data.myScore}ì  vs ìƒëŒ€: {data.opponentScore}ì `
		end
		if rewardLbl then
			rewardLbl.Text = "ë‹¤ì‹œ ë„ì „í•´ë³´ì„¸ìš”!"
		end
	end

	-- ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜
	resultFrame.Size = UDim2.new(0, 360, 0, 0)
	resultGui.Enabled = true
	TweenService:Create(
		resultFrame,
		TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out),
		{ Size = UDim2.new(0, 360, 0, 230) }
	):Play()

	-- 8ì´ˆ í›„ ìë™ ë‹«ê¸°
	task.delay(8, function()
		if resultGui then
			resultGui.Enabled = false
		end
	end)
end

-- ==================== ì •ë¦¬ ====================

function RealtimeBattleController:Destroy()
	for _, conn in self._connections do
		conn:Disconnect()
	end
	self._connections = {}
	if self._queueGui then
		self._queueGui:Destroy()
		self._queueGui = nil
	end
	if self._hudGui then
		self._hudGui:Destroy()
		self._hudGui = nil
	end
	if self._resultGui then
		self._resultGui:Destroy()
		self._resultGui = nil
	end
	if self._lobbyGui then
		self._lobbyGui:Destroy()
		self._lobbyGui = nil
	end
end

return RealtimeBattleController
