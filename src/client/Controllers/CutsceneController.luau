--!strict
-- CutsceneController
-- ì±•í„° í•´ê¸ˆ ì‹œ ì»·ì”¬(ëŒ€í™”ì°½) í‘œì‹œ ë° íƒ€ì´í•‘ ì• ë‹ˆë©”ì´ì…˜ ì²˜ë¦¬

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")

local RemoteEvents = require(game:GetService("ReplicatedStorage").Shared.RemoteEvents)

local CutsceneController = {}
CutsceneController.__index = CutsceneController

-- ìŠ¤í‚¬ë³„ ì²« íšë“ íŠœí† ë¦¬ì–¼ ì•ˆë‚´ í…ìŠ¤íŠ¸
local SKILL_TUTORIAL = {
	double_jump = {
		icon = "â¬†ï¸",
		name = "2ë‹¨ ì í”„",
		howto = "ê³µì¤‘ì—ì„œ ì í”„ ë²„íŠ¼ì„ í•œ ë²ˆ ë” ëˆ„ë¥´ì„¸ìš”!",
		tip = "ğŸ’¡ ë†’ì€ ì¥ì• ë¬¼ë„ ê±°ëœ¬íˆ ë„˜ì„ ìˆ˜ ìˆì–´ìš”",
	},
	dash = {
		icon = "ğŸ’¨",
		name = "ëŒ€ì‰¬",
		howto = "í™”ë©´ ìš°ì¸¡ì˜ ëŒ€ì‰¬ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”! (ì¿¨ë‹¤ìš´ 8ì´ˆ)",
		tip = "ğŸ’¡ ì¥ì• ë¬¼ ì§ì „ì— ì“°ë©´ ê·¸ëƒ¥ í†µê³¼í•´ìš”",
	},
	shield_regen = {
		icon = "ğŸ›¡ï¸",
		name = "ì‰´ë“œ ì¬ìƒ",
		howto = "60ì´ˆë§ˆë‹¤ ìë™ìœ¼ë¡œ ì‰´ë“œê°€ 1ì¹¸ íšŒë³µë¼ìš”!",
		tip = "ğŸ’¡ ì˜¤ë˜ ì‚´ì•„ë‚¨ì„ìˆ˜ë¡ ì ì  ìœ ë¦¬í•´ì ¸ìš”",
	},
	magnet_burst = {
		icon = "ğŸ§²",
		name = "ìì„ í­ë°œ",
		howto = "ì¥ì• ë¬¼ì— ë§ìœ¼ë©´ ì£¼ë³€ ì½”ì¸ì´ ì „ë¶€ í¡ìˆ˜ë¼ìš”!",
		tip = "ğŸ’¡ ì½”ì¸ì´ ë¹½ë¹½í•œ êµ¬ê°„ì—ì„œ íŠ¹íˆ ê°•ë ¥í•´ìš”",
	},
	fever_boost = {
		icon = "ğŸ”¥",
		name = "í”¼ë²„ ë¶€ìŠ¤íŠ¸",
		howto = "í”¼ë²„ ê²Œì´ì§€ê°€ 30% ë” ë¹ ë¥´ê²Œ ì±„ì›Œì ¸ìš”!",
		tip = "ğŸ’¡ ìë™ ì ìš©! í”¼ë²„ íƒ€ì„ì„ ìì£¼ ë…¸ë¦¬ì„¸ìš”",
	},
}

export type CutsceneController = typeof(setmetatable(
	{} :: {
		_player: Player,
		_connections: { RBXScriptConnection },
		_gui: ScreenGui?,
		_panel: Frame?,
		_speakerLabel: TextLabel?,
		_dialogueLabel: TextLabel?,
		_nextBtn: TextButton?,
		_skipBtn: TextButton?,
		_isPlaying: boolean,
		_currentLineIndex: number,
		_currentLines: { { speaker: string, text: string } },
		_cutsceneQueue: { { lines: { { speaker: string, text: string } }, title: string? } },
		_typingThread: thread?,
		-- ìŠ¤í‚¬ íŠœí† ë¦¬ì–¼
		_pendingSkillTutorial: string?,
		_shownSkillTutorials: { [string]: boolean },
	},
	CutsceneController
))

function CutsceneController.new(): CutsceneController
	local self = setmetatable({
		_player = Players.LocalPlayer,
		_connections = {},
		_gui = nil,
		_panel = nil,
		_speakerLabel = nil,
		_dialogueLabel = nil,
		_nextBtn = nil,
		_skipBtn = nil,
		_isPlaying = false,
		_currentLineIndex = 0,
		_currentLines = {},
		_cutsceneQueue = {},
		_typingThread = nil,
		_pendingSkillTutorial = nil,
		_shownSkillTutorials = {},
	}, CutsceneController)

	self:_createGui()
	self:_setupEventHandlers()

	return self
end

-- ==================== GUI ìƒì„± ====================

function CutsceneController:_createGui()
	local playerGui = self._player:WaitForChild("PlayerGui")

	local gui = Instance.new("ScreenGui")
	gui.Name = "CutsceneGui"
	gui.ResetOnSpawn = false
	gui.DisplayOrder = 20 -- ìµœìƒìœ„ ë ˆì´ì–´
	gui.Enabled = false
	gui.Parent = playerGui
	self._gui = gui

	-- í•˜ë‹¨ íŒ¨ë„ (í™”ë©´ í•˜ë‹¨ 28%)
	local panel = Instance.new("Frame")
	panel.Name = "CutscenePanel"
	panel.Size = UDim2.new(1, 0, 0.28, 0)
	panel.Position = UDim2.new(0, 0, 0.72, 0)
	panel.BackgroundColor3 = Color3.fromRGB(10, 10, 20)
	panel.BackgroundTransparency = 0.1
	panel.BorderSizePixel = 0
	panel.Parent = gui
	self._panel = panel

	-- ìƒë‹¨ í…Œë‘ë¦¬ ë¼ì¸
	local topBorder = Instance.new("Frame")
	topBorder.Size = UDim2.new(1, 0, 0, 3)
	topBorder.Position = UDim2.new(0, 0, 0, 0)
	topBorder.BackgroundColor3 = Color3.fromRGB(100, 180, 255)
	topBorder.BorderSizePixel = 0
	topBorder.Parent = panel

	-- í™”ì ì´ë¦„ ë ˆì´ë¸”
	local speakerBg = Instance.new("Frame")
	speakerBg.Name = "SpeakerBg"
	speakerBg.Size = UDim2.new(0, 180, 0, 28)
	speakerBg.Position = UDim2.new(0, 16, 0, -14)
	speakerBg.BackgroundColor3 = Color3.fromRGB(40, 80, 160)
	speakerBg.BorderSizePixel = 0
	speakerBg.Parent = panel

	local speakerBgCorner = Instance.new("UICorner")
	speakerBgCorner.CornerRadius = UDim.new(0, 6)
	speakerBgCorner.Parent = speakerBg

	local speakerLabel = Instance.new("TextLabel")
	speakerLabel.Name = "SpeakerLabel"
	speakerLabel.Size = UDim2.new(1, -12, 1, 0)
	speakerLabel.Position = UDim2.new(0, 8, 0, 0)
	speakerLabel.BackgroundTransparency = 1
	speakerLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
	speakerLabel.TextSize = 14
	speakerLabel.Font = Enum.Font.GothamBold
	speakerLabel.Text = ""
	speakerLabel.TextXAlignment = Enum.TextXAlignment.Left
	speakerLabel.Parent = speakerBg
	self._speakerLabel = speakerLabel

	-- ëŒ€í™” í…ìŠ¤íŠ¸
	local dialogueLabel = Instance.new("TextLabel")
	dialogueLabel.Name = "DialogueLabel"
	dialogueLabel.Size = UDim2.new(1, -100, 1, -20)
	dialogueLabel.Position = UDim2.new(0, 16, 0, 24)
	dialogueLabel.BackgroundTransparency = 1
	dialogueLabel.TextColor3 = Color3.fromRGB(230, 230, 240)
	dialogueLabel.TextSize = 16
	dialogueLabel.Font = Enum.Font.Gotham
	dialogueLabel.Text = ""
	dialogueLabel.TextXAlignment = Enum.TextXAlignment.Left
	dialogueLabel.TextYAlignment = Enum.TextYAlignment.Top
	dialogueLabel.TextWrapped = true
	dialogueLabel.Parent = panel
	self._dialogueLabel = dialogueLabel

	-- ë‹¤ìŒ ë²„íŠ¼
	local nextBtn = Instance.new("TextButton")
	nextBtn.Name = "NextBtn"
	nextBtn.Size = UDim2.new(0, 72, 0, 34)
	nextBtn.Position = UDim2.new(1, -84, 1, -48)
	nextBtn.BackgroundColor3 = Color3.fromRGB(60, 120, 220)
	nextBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
	nextBtn.TextSize = 14
	nextBtn.Font = Enum.Font.GothamBold
	nextBtn.Text = "ë‹¤ìŒ â–¶"
	nextBtn.Parent = panel
	self._nextBtn = nextBtn

	local nextCorner = Instance.new("UICorner")
	nextCorner.CornerRadius = UDim.new(0, 8)
	nextCorner.Parent = nextBtn

	-- ê±´ë„ˆë›°ê¸° ë²„íŠ¼
	local skipBtn = Instance.new("TextButton")
	skipBtn.Name = "SkipBtn"
	skipBtn.Size = UDim2.new(0, 72, 0, 22)
	skipBtn.Position = UDim2.new(1, -84, 0, 8)
	skipBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 70)
	skipBtn.TextColor3 = Color3.fromRGB(150, 150, 170)
	skipBtn.TextSize = 12
	skipBtn.Font = Enum.Font.Gotham
	skipBtn.Text = "ê±´ë„ˆë›°ê¸°"
	skipBtn.Parent = panel
	self._skipBtn = skipBtn

	local skipCorner = Instance.new("UICorner")
	skipCorner.CornerRadius = UDim.new(0, 6)
	skipCorner.Parent = skipBtn

	-- ë²„íŠ¼ ì—°ê²°
	nextBtn.MouseButton1Click:Connect(function()
		self:_onNextPressed()
	end)

	skipBtn.MouseButton1Click:Connect(function()
		self:_skipAll()
	end)
end

-- ==================== ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ====================

function CutsceneController:_setupEventHandlers()
	-- ì±•í„° í•´ê¸ˆ/ì™„ë£Œ ì´ë²¤íŠ¸ â†’ ì»·ì”¬ íì— ì¶”ê°€
	local conn = RemoteEvents.ChapterUnlocked.OnClientEvent:Connect(function(data)
		if data.cutscene and #data.cutscene > 0 then
			local title = if data.isOpening
				then data.chapterTheme .. " " .. data.chapterName
				else data.chapterTheme .. " " .. data.chapterName .. " ì™„ë£Œ!"
			self:QueueCutscene(data.cutscene, title)
		end
		-- ìŠ¤í‚¬ í•´ê¸ˆ ì‹œ ì»·ì”¬ ì´í›„ì— íŠœí† ë¦¬ì–¼ í‘œì‹œ ì˜ˆì•½
		if data.skillUnlocked and not self._shownSkillTutorials[data.skillUnlocked] then
			self._pendingSkillTutorial = data.skillUnlocked
		end
	end)
	table.insert(self._connections, conn)
end

-- ==================== ì»·ì”¬ ì¬ìƒ ====================

-- ì»·ì”¬ íì— ì¶”ê°€ (ì—¬ëŸ¬ ì»·ì”¬ì´ ì—°ì† ë°œìƒ ì‹œ ìˆœì„œëŒ€ë¡œ ì¬ìƒ)
function CutsceneController:QueueCutscene(
	lines: { { speaker: string, text: string } },
	title: string?
)
	table.insert(self._cutsceneQueue, { lines = lines, title = title })
	if not self._isPlaying then
		self:_playNext()
	end
end

function CutsceneController:_playNext()
	if #self._cutsceneQueue == 0 then
		self:_hide()
		-- ì»·ì”¬ì´ ëª¨ë‘ ëë‚œ í›„ ìŠ¤í‚¬ íŠœí† ë¦¬ì–¼ í‘œì‹œ
		local pendingSkill = self._pendingSkillTutorial
		if pendingSkill and not self._shownSkillTutorials[pendingSkill] then
			self._pendingSkillTutorial = nil
			self._shownSkillTutorials[pendingSkill] = true
			task.delay(0.6, function()
				self:_showSkillTutorial(pendingSkill)
			end)
		end
		return
	end

	local cutscene = table.remove(self._cutsceneQueue, 1)
	self._currentLines = cutscene.lines
	self._currentLineIndex = 0
	self._isPlaying = true

	self:_show()
	self:_advanceLine()
end

function CutsceneController:_advanceLine()
	self._currentLineIndex += 1

	if self._currentLineIndex > #self._currentLines then
		-- ì»·ì”¬ ì¢…ë£Œ â†’ ë‹¤ìŒ ì»·ì”¬ ë˜ëŠ” ìˆ¨ê¸°ê¸°
		task.delay(0.3, function()
			self._isPlaying = false
			self:_playNext()
		end)
		return
	end

	local line = self._currentLines[self._currentLineIndex]
	if self._speakerLabel then
		self._speakerLabel.Text = line.speaker
	end
	if self._dialogueLabel then
		self._dialogueLabel.Text = ""
	end

	-- íƒ€ì´í•‘ ì• ë‹ˆë©”ì´ì…˜
	self:_typeText(line.text)
end

function CutsceneController:_typeText(text: string)
	-- ì´ì „ íƒ€ì´í•‘ ìŠ¤ë ˆë“œ ì·¨ì†Œ
	if self._typingThread and coroutine.status(self._typingThread) == "suspended" then
		task.cancel(self._typingThread)
	end

	self._typingThread = task.spawn(function()
		local label = self._dialogueLabel
		if not label then
			return
		end

		local chars = string.len(text)
		for i = 1, chars do
			label.Text = string.sub(text, 1, i)
			task.wait(0.03) -- íƒ€ì´í•‘ ì†ë„: 30ms per char
		end
		self._typingThread = nil
	end)
end

-- í˜„ì¬ ë¼ì¸ ì¦‰ì‹œ ì™„ì„± or ì „ì²´ ìŠ¤í‚µ
function CutsceneController:_onNextPressed()
	-- íƒ€ì´í•‘ ì¤‘ì´ë©´ ì¦‰ì‹œ ì™„ì„±
	if self._typingThread then
		if self._typingThread and coroutine.status(self._typingThread) ~= "dead" then
			task.cancel(self._typingThread)
			self._typingThread = nil
		end
		local line = self._currentLines[self._currentLineIndex]
		if self._dialogueLabel and line then
			self._dialogueLabel.Text = line.text
		end
		return
	end
	-- ë‹¤ìŒ ë¼ì¸ìœ¼ë¡œ
	self:_advanceLine()
end

function CutsceneController:_skipAll()
	if self._typingThread then
		task.cancel(self._typingThread)
		self._typingThread = nil
	end
	self._cutsceneQueue = {}
	self._isPlaying = false
	self:_hide()
	-- ê±´ë„ˆë›°ê¸° ì‹œì—ë„ ìŠ¤í‚¬ íŠœí† ë¦¬ì–¼ì€ í‘œì‹œ
	local pendingSkill = self._pendingSkillTutorial
	if pendingSkill and not self._shownSkillTutorials[pendingSkill] then
		self._pendingSkillTutorial = nil
		self._shownSkillTutorials[pendingSkill] = true
		task.delay(0.6, function()
			self:_showSkillTutorial(pendingSkill)
		end)
	end
end

-- ==================== í‘œì‹œ/ìˆ¨ê¸°ê¸° ====================

function CutsceneController:_show()
	local gui = self._gui
	local panel = self._panel
	if not gui or not panel then
		return
	end

	gui.Enabled = true
	panel.Position = UDim2.new(0, 0, 1, 0) -- í™”ë©´ ì•„ë˜ì„œ ìŠ¬ë¼ì´ë“œ ì—…
	TweenService:Create(panel, TweenInfo.new(0.35, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
		Position = UDim2.new(0, 0, 0.72, 0),
	}):Play()
end

function CutsceneController:_hide()
	local gui = self._gui
	local panel = self._panel
	if not gui or not panel then
		return
	end

	TweenService:Create(panel, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
		Position = UDim2.new(0, 0, 1, 0),
	}):Play()

	task.delay(0.3, function()
		gui.Enabled = false
	end)
end

-- ==================== ìŠ¤í‚¬ íŠœí† ë¦¬ì–¼ ì˜¤ë²„ë ˆì´ ====================

function CutsceneController:_showSkillTutorial(skillId: string)
	local info = SKILL_TUTORIAL[skillId]
	if not info then
		return
	end

	local playerGui = self._player:WaitForChild("PlayerGui")

	local tutGui = Instance.new("ScreenGui")
	tutGui.Name = "SkillTutorialGui"
	tutGui.ResetOnSpawn = false
	tutGui.DisplayOrder = 22
	tutGui.Parent = playerGui

	-- ë°°ê²½ (íƒ­í•´ì„œ ë‹«ê¸° ê°€ëŠ¥)
	local dimBg = Instance.new("TextButton")
	dimBg.Size = UDim2.new(1, 0, 1, 0)
	dimBg.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
	dimBg.BackgroundTransparency = 0.5
	dimBg.Text = ""
	dimBg.AutoButtonColor = false
	dimBg.Parent = tutGui

	-- ì¹´ë“œ
	local card = Instance.new("Frame")
	card.Name = "SkillCard"
	card.Size = UDim2.new(0, 300, 0, 196)
	card.Position = UDim2.new(0.5, -150, 0.5, -98)
	card.BackgroundColor3 = Color3.fromRGB(14, 18, 36)
	card.BorderSizePixel = 0
	card.Parent = tutGui

	local cardCorner = Instance.new("UICorner")
	cardCorner.CornerRadius = UDim.new(0, 16)
	cardCorner.Parent = card

	local cardStroke = Instance.new("UIStroke")
	cardStroke.Color = Color3.fromRGB(160, 100, 255)
	cardStroke.Thickness = 2
	cardStroke.Parent = card

	-- ìƒˆ ìŠ¤í‚¬ ë±ƒì§€
	local badge = Instance.new("Frame")
	badge.Size = UDim2.new(0, 130, 0, 24)
	badge.Position = UDim2.new(0.5, -65, 0, -12)
	badge.BackgroundColor3 = Color3.fromRGB(140, 80, 240)
	badge.BorderSizePixel = 0
	badge.Parent = tutGui

	local badgeCorner = Instance.new("UICorner")
	badgeCorner.CornerRadius = UDim.new(0, 12)
	badgeCorner.Parent = badge

	local badgeLabel = Instance.new("TextLabel")
	badgeLabel.Size = UDim2.new(1, 0, 1, 0)
	badgeLabel.BackgroundTransparency = 1
	badgeLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
	badgeLabel.TextSize = 12
	badgeLabel.Font = Enum.Font.GothamBold
	badgeLabel.Text = "ğŸŒŸ ìƒˆ ìŠ¤í‚¬ íšë“!"
	badgeLabel.Parent = badge

	-- ì•„ì´ì½˜
	local iconBg = Instance.new("Frame")
	iconBg.Size = UDim2.new(0, 64, 0, 64)
	iconBg.Position = UDim2.new(0.5, -32, 0, 18)
	iconBg.BackgroundColor3 = Color3.fromRGB(30, 20, 60)
	iconBg.BorderSizePixel = 0
	iconBg.Parent = card

	local iconBgCorner = Instance.new("UICorner")
	iconBgCorner.CornerRadius = UDim.new(0, 12)
	iconBgCorner.Parent = iconBg

	local iconStroke = Instance.new("UIStroke")
	iconStroke.Color = Color3.fromRGB(160, 100, 255)
	iconStroke.Thickness = 2
	iconStroke.Parent = iconBg

	local iconLabel = Instance.new("TextLabel")
	iconLabel.Size = UDim2.new(1, 0, 1, 0)
	iconLabel.BackgroundTransparency = 1
	iconLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
	iconLabel.TextSize = 32
	iconLabel.Font = Enum.Font.GothamBold
	iconLabel.Text = info.icon
	iconLabel.Parent = iconBg

	-- ìŠ¤í‚¬ ì´ë¦„
	local nameLabel = Instance.new("TextLabel")
	nameLabel.Size = UDim2.new(1, -20, 0, 24)
	nameLabel.Position = UDim2.new(0, 10, 0, 88)
	nameLabel.BackgroundTransparency = 1
	nameLabel.TextColor3 = Color3.fromRGB(210, 170, 255)
	nameLabel.TextSize = 18
	nameLabel.Font = Enum.Font.GothamBlack
	nameLabel.Text = info.name
	nameLabel.Parent = card

	-- ì‚¬ìš©ë²•
	local howtoLabel = Instance.new("TextLabel")
	howtoLabel.Size = UDim2.new(1, -24, 0, 34)
	howtoLabel.Position = UDim2.new(0, 12, 0, 116)
	howtoLabel.BackgroundTransparency = 1
	howtoLabel.TextColor3 = Color3.fromRGB(220, 225, 240)
	howtoLabel.TextSize = 13
	howtoLabel.Font = Enum.Font.Gotham
	howtoLabel.Text = info.howto
	howtoLabel.TextWrapped = true
	howtoLabel.TextXAlignment = Enum.TextXAlignment.Center
	howtoLabel.Parent = card

	-- íŒ
	local tipLabel = Instance.new("TextLabel")
	tipLabel.Size = UDim2.new(1, -24, 0, 22)
	tipLabel.Position = UDim2.new(0, 12, 0, 150)
	tipLabel.BackgroundTransparency = 1
	tipLabel.TextColor3 = Color3.fromRGB(160, 200, 140)
	tipLabel.TextSize = 11
	tipLabel.Font = Enum.Font.Gotham
	tipLabel.Text = info.tip
	tipLabel.Parent = card

	-- í™•ì¸ ë²„íŠ¼ (ì¹´ìš´íŠ¸ë‹¤ìš´ í¬í•¨)
	local dismissBtn = Instance.new("TextButton")
	dismissBtn.Size = UDim2.new(1, -24, 0, 32)
	dismissBtn.Position = UDim2.new(0, 12, 1, -40)
	dismissBtn.BackgroundColor3 = Color3.fromRGB(100, 60, 200)
	dismissBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
	dismissBtn.TextSize = 14
	dismissBtn.Font = Enum.Font.GothamBold
	dismissBtn.Text = "í™•ì¸! (6)"
	dismissBtn.Parent = card

	local dismissCorner = Instance.new("UICorner")
	dismissCorner.CornerRadius = UDim.new(0, 8)
	dismissCorner.Parent = dismissBtn

	-- ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜
	card.Position = UDim2.new(0.5, -150, 0.5, -98 + 40)
	card.BackgroundTransparency = 1
	TweenService:Create(card, TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
		Position = UDim2.new(0.5, -150, 0.5, -98),
		BackgroundTransparency = 0,
	}):Play()

	local function closeTutorial()
		TweenService:Create(card, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
			Position = UDim2.new(0.5, -150, 0.5, -98 + 30),
			BackgroundTransparency = 1,
		}):Play()
		task.delay(0.25, function()
			tutGui:Destroy()
		end)
	end

	dimBg.MouseButton1Click:Connect(closeTutorial)
	dismissBtn.MouseButton1Click:Connect(closeTutorial)

	-- 6ì´ˆ ì¹´ìš´íŠ¸ë‹¤ìš´ í›„ ìë™ ë‹«ê¸°
	task.spawn(function()
		for i = 5, 1, -1 do
			task.wait(1)
			if not dismissBtn.Parent then
				return
			end
			dismissBtn.Text = `í™•ì¸! ({i})`
		end
		task.wait(1)
		if tutGui.Parent then
			closeTutorial()
		end
	end)
end

return CutsceneController
