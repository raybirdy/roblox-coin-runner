--!strict
-- CutsceneController
-- Ï±ïÌÑ∞ Ìï¥Í∏à Ïãú Ïª∑Ïî¨(ÎåÄÌôîÏ∞Ω) ÌëúÏãú Î∞è ÌÉÄÏù¥Ìïë Ïï†ÎãàÎ©îÏù¥ÏÖò Ï≤òÎ¶¨
-- PR #2: Ï¥àÏÉÅÌôî ÏãúÏä§ÌÖú, Ïó≠Ìï†Î≥Ñ ÏÉâÏÉÅ, shake/flash/particle Ïù¥ÌéôÌä∏ Ï∂îÍ∞Ä

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RemoteEvents = require(ReplicatedStorage.Shared.RemoteEvents)
local ScenarioConstants = require(ReplicatedStorage.Shared.Constants.ScenarioConstants)

local CutsceneController = {}
CutsceneController.__index = CutsceneController

-- Ïä§ÌÇ¨Î≥Ñ Ï≤´ ÌöçÎìù ÌäúÌÜ†Î¶¨Ïñº ÏïàÎÇ¥ ÌÖçÏä§Ìä∏
local SKILL_TUTORIAL = {
	double_jump = {
		icon = "‚¨ÜÔ∏è",
		name = "2Îã® Ï†êÌîÑ",
		howto = "Í≥µÏ§ëÏóêÏÑú Ï†êÌîÑ Î≤ÑÌäºÏùÑ Ìïú Î≤à Îçî ÎàÑÎ•¥ÏÑ∏Ïöî!",
		tip = "üí° ÎÜíÏùÄ Ïû•Ïï†Î¨ºÎèÑ Í±∞Îú¨Ìûà ÎÑòÏùÑ Ïàò ÏûàÏñ¥Ïöî",
	},
	dash = {
		icon = "üí®",
		name = "ÎåÄÏâ¨",
		howto = "ÌôîÎ©¥ Ïö∞Ï∏°Ïùò ÎåÄÏâ¨ Î≤ÑÌäºÏùÑ ÎàÑÎ•¥ÏÑ∏Ïöî! (Ïø®Îã§Ïö¥ 8Ï¥à)",
		tip = "üí° Ïû•Ïï†Î¨º ÏßÅÏ†ÑÏóê Ïì∞Î©¥ Í∑∏ÎÉ• ÌÜµÍ≥ºÌï¥Ïöî",
	},
	shield_regen = {
		icon = "üõ°Ô∏è",
		name = "Ïâ¥Îìú Ïû¨ÏÉù",
		howto = "60Ï¥àÎßàÎã§ ÏûêÎèôÏúºÎ°ú Ïâ¥ÎìúÍ∞Ä 1Ïπ∏ ÌöåÎ≥µÎèºÏöî!",
		tip = "üí° Ïò§Îûò ÏÇ¥ÏïÑÎÇ®ÏùÑÏàòÎ°ù Ï†êÏ†ê Ïú†Î¶¨Ìï¥Ï†∏Ïöî",
	},
	magnet_burst = {
		icon = "üß≤",
		name = "ÏûêÏÑù Ìè≠Î∞ú",
		howto = "Ïû•Ïï†Î¨ºÏóê ÎßûÏúºÎ©¥ Ï£ºÎ≥Ä ÏΩîÏù∏Ïù¥ Ï†ÑÎ∂Ä Ìù°ÏàòÎèºÏöî!",
		tip = "üí° ÏΩîÏù∏Ïù¥ ÎπΩÎπΩÌïú Íµ¨Í∞ÑÏóêÏÑú ÌäπÌûà Í∞ïÎ†•Ìï¥Ïöî",
	},
	fever_boost = {
		icon = "üî•",
		name = "ÌîºÎ≤Ñ Î∂ÄÏä§Ìä∏",
		howto = "ÌîºÎ≤Ñ Í≤åÏù¥ÏßÄÍ∞Ä 30% Îçî Îπ†Î•¥Í≤å Ï±ÑÏõåÏ†∏Ïöî!",
		tip = "üí° ÏûêÎèô Ï†ÅÏö©! ÌîºÎ≤Ñ ÌÉÄÏûÑÏùÑ ÏûêÏ£º ÎÖ∏Î¶¨ÏÑ∏Ïöî",
	},
}

-- Ïó≠Ìï†Î≥Ñ ÌÖåÎëêÎ¶¨/Í∞ïÏ°∞ ÏÉâÏÉÅ
local ROLE_COLORS = {
	hero    = Color3.fromRGB(100, 220, 100),
	villain = Color3.fromRGB(220, 50, 50),
	ally    = Color3.fromRGB(100, 180, 255),
	mentor  = Color3.fromRGB(150, 120, 255),
}

export type CutsceneController = typeof(setmetatable(
	{} :: {
		_player: Player,
		_connections: { RBXScriptConnection },
		_gui: ScreenGui?,
		_panel: Frame?,
		_speakerLabel: TextLabel?,
		_dialogueLabel: TextLabel?,
		_nextBtn: TextButton?,
		_skipBtn: TextButton?,
		_isPlaying: boolean,
		_currentLineIndex: number,
		_currentLines: { { speaker: string?, text: string, characterId: string?, effect: string? } },
		_cutsceneQueue: { { lines: { { speaker: string?, text: string, characterId: string?, effect: string? } }, title: string? } },
		_typingThread: thread?,
		-- Ïä§ÌÇ¨ ÌäúÌÜ†Î¶¨Ïñº
		_pendingSkillTutorial: string?,
		_shownSkillTutorials: { [string]: boolean },
		-- Ï¥àÏÉÅÌôî ÏãúÏä§ÌÖú (Ïã†Í∑ú)
		_portraitFrame: Frame?,
		_portraitEmoji: TextLabel?,
		_speakerBg: Frame?,
		_topBorder: Frame?,
		_currentChapterId: string?,
	},
	CutsceneController
))

function CutsceneController.new(): CutsceneController
	local self = setmetatable({
		_player = Players.LocalPlayer,
		_connections = {},
		_gui = nil,
		_panel = nil,
		_speakerLabel = nil,
		_dialogueLabel = nil,
		_nextBtn = nil,
		_skipBtn = nil,
		_isPlaying = false,
		_currentLineIndex = 0,
		_currentLines = {},
		_cutsceneQueue = {},
		_typingThread = nil,
		_pendingSkillTutorial = nil,
		_shownSkillTutorials = {},
		_portraitFrame = nil,
		_portraitEmoji = nil,
		_speakerBg = nil,
		_topBorder = nil,
		_currentChapterId = nil,
	}, CutsceneController)

	self:_createGui()
	self:_setupEventHandlers()

	return self
end

-- ==================== GUI ÏÉùÏÑ± ====================

function CutsceneController:_createGui()
	local playerGui = self._player:WaitForChild("PlayerGui")

	local gui = Instance.new("ScreenGui")
	gui.Name = "CutsceneGui"
	gui.ResetOnSpawn = false
	gui.DisplayOrder = 20
	gui.Enabled = false
	gui.Parent = playerGui
	self._gui = gui

	-- ÌïòÎã® Ìå®ÎÑê (ÌôîÎ©¥ ÌïòÎã® 28%)
	local panel = Instance.new("Frame")
	panel.Name = "CutscenePanel"
	panel.Size = UDim2.new(1, 0, 0.28, 0)
	panel.Position = UDim2.new(0, 0, 0.72, 0)
	panel.BackgroundColor3 = Color3.fromRGB(10, 10, 20)
	panel.BackgroundTransparency = 0.1
	panel.BorderSizePixel = 0
	panel.Parent = gui
	self._panel = panel

	-- ÏÉÅÎã® ÌÖåÎëêÎ¶¨ ÎùºÏù∏ (Ïó≠Ìï†Î≥Ñ ÎèôÏ†Å ÏÉâÏÉÅ)
	local topBorder = Instance.new("Frame")
	topBorder.Name = "TopBorder"
	topBorder.Size = UDim2.new(1, 0, 0, 3)
	topBorder.Position = UDim2.new(0, 0, 0, 0)
	topBorder.BackgroundColor3 = Color3.fromRGB(100, 180, 255)
	topBorder.BorderSizePixel = 0
	topBorder.Parent = panel
	self._topBorder = topBorder

	-- Ï∫êÎ¶≠ÌÑ∞ Ï¥àÏÉÅÌôî ÏõêÌòï ÌîÑÎ†àÏûÑ (Ìå®ÎÑê Ï¢åÏ∏° ÏÉÅÎã®, Ìå®ÎÑê ÏúÑÎ°ú ÎèåÏ∂ú)
	local portraitFrame = Instance.new("Frame")
	portraitFrame.Name = "PortraitFrame"
	portraitFrame.Size = UDim2.new(0, 60, 0, 60)
	portraitFrame.Position = UDim2.new(0, 12, 0, -36)
	portraitFrame.BackgroundColor3 = Color3.fromRGB(40, 80, 160)
	portraitFrame.BorderSizePixel = 0
	portraitFrame.Parent = panel
	self._portraitFrame = portraitFrame

	local portraitCorner = Instance.new("UICorner")
	portraitCorner.CornerRadius = UDim.new(1, 0)
	portraitCorner.Parent = portraitFrame

	local portraitStroke = Instance.new("UIStroke")
	portraitStroke.Color = Color3.fromRGB(100, 180, 255)
	portraitStroke.Thickness = 3
	portraitStroke.Parent = portraitFrame

	local portraitEmoji = Instance.new("TextLabel")
	portraitEmoji.Name = "PortraitEmoji"
	portraitEmoji.Size = UDim2.new(1, 0, 1, 0)
	portraitEmoji.BackgroundTransparency = 1
	portraitEmoji.Text = "ü¶â"
	portraitEmoji.TextSize = 28
	portraitEmoji.Font = Enum.Font.GothamBold
	portraitEmoji.Parent = portraitFrame
	self._portraitEmoji = portraitEmoji

	-- ÌôîÏûê Ïù¥Î¶Ñ Î∞∞Í≤Ω (Ï¥àÏÉÅÌôî Ïò§Î•∏Ï™ΩÏúºÎ°ú Ïù¥Îèô)
	local speakerBg = Instance.new("Frame")
	speakerBg.Name = "SpeakerBg"
	speakerBg.Size = UDim2.new(0, 180, 0, 28)
	speakerBg.Position = UDim2.new(0, 80, 0, -14)
	speakerBg.BackgroundColor3 = Color3.fromRGB(40, 80, 160)
	speakerBg.BorderSizePixel = 0
	speakerBg.Parent = panel
	self._speakerBg = speakerBg

	local speakerBgCorner = Instance.new("UICorner")
	speakerBgCorner.CornerRadius = UDim.new(0, 6)
	speakerBgCorner.Parent = speakerBg

	local speakerLabel = Instance.new("TextLabel")
	speakerLabel.Name = "SpeakerLabel"
	speakerLabel.Size = UDim2.new(1, -12, 1, 0)
	speakerLabel.Position = UDim2.new(0, 8, 0, 0)
	speakerLabel.BackgroundTransparency = 1
	speakerLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
	speakerLabel.TextSize = 13
	speakerLabel.Font = Enum.Font.GothamBold
	speakerLabel.Text = ""
	speakerLabel.TextXAlignment = Enum.TextXAlignment.Left
	speakerLabel.Parent = speakerBg
	self._speakerLabel = speakerLabel

	-- ÎåÄÌôî ÌÖçÏä§Ìä∏ (Ï¥àÏÉÅÌôî Ïò§Î•∏Ï™Ω Í≥µÍ∞Ñ)
	local dialogueLabel = Instance.new("TextLabel")
	dialogueLabel.Name = "DialogueLabel"
	dialogueLabel.Size = UDim2.new(1, -160, 1, -20)
	dialogueLabel.Position = UDim2.new(0, 80, 0, 24)
	dialogueLabel.BackgroundTransparency = 1
	dialogueLabel.TextColor3 = Color3.fromRGB(230, 230, 240)
	dialogueLabel.TextSize = 16
	dialogueLabel.Font = Enum.Font.Gotham
	dialogueLabel.Text = ""
	dialogueLabel.TextXAlignment = Enum.TextXAlignment.Left
	dialogueLabel.TextYAlignment = Enum.TextYAlignment.Top
	dialogueLabel.TextWrapped = true
	dialogueLabel.Parent = panel
	self._dialogueLabel = dialogueLabel

	-- Îã§Ïùå Î≤ÑÌäº
	local nextBtn = Instance.new("TextButton")
	nextBtn.Name = "NextBtn"
	nextBtn.Size = UDim2.new(0, 72, 0, 34)
	nextBtn.Position = UDim2.new(1, -84, 1, -48)
	nextBtn.BackgroundColor3 = Color3.fromRGB(60, 120, 220)
	nextBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
	nextBtn.TextSize = 14
	nextBtn.Font = Enum.Font.GothamBold
	nextBtn.Text = "Îã§Ïùå ‚ñ∂"
	nextBtn.Parent = panel
	self._nextBtn = nextBtn

	local nextCorner = Instance.new("UICorner")
	nextCorner.CornerRadius = UDim.new(0, 8)
	nextCorner.Parent = nextBtn

	-- Í±¥ÎÑàÎõ∞Í∏∞ Î≤ÑÌäº
	local skipBtn = Instance.new("TextButton")
	skipBtn.Name = "SkipBtn"
	skipBtn.Size = UDim2.new(0, 72, 0, 22)
	skipBtn.Position = UDim2.new(1, -84, 0, 8)
	skipBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 70)
	skipBtn.TextColor3 = Color3.fromRGB(150, 150, 170)
	skipBtn.TextSize = 12
	skipBtn.Font = Enum.Font.Gotham
	skipBtn.Text = "Í±¥ÎÑàÎõ∞Í∏∞"
	skipBtn.Parent = panel
	self._skipBtn = skipBtn

	local skipCorner = Instance.new("UICorner")
	skipCorner.CornerRadius = UDim.new(0, 6)
	skipCorner.Parent = skipBtn

	-- Î≤ÑÌäº Ïó∞Í≤∞
	nextBtn.MouseButton1Click:Connect(function()
		self:_onNextPressed()
	end)

	skipBtn.MouseButton1Click:Connect(function()
		self:_skipAll()
	end)
end

-- ==================== Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨ ====================

function CutsceneController:_setupEventHandlers()
	local conn = RemoteEvents.ChapterUnlocked.OnClientEvent:Connect(function(data)
		if data.cutscene and #data.cutscene > 0 then
			local title = if data.isOpening
				then data.chapterTheme .. " " .. data.chapterName
				else data.chapterTheme .. " " .. data.chapterName .. " ÏôÑÎ£å!"
			self:QueueCutscene(data.cutscene, title, data.chapterId)
		end
		if data.skillUnlocked and not self._shownSkillTutorials[data.skillUnlocked] then
			self._pendingSkillTutorial = data.skillUnlocked
		end
	end)
	table.insert(self._connections, conn)
end

-- ==================== Ïª∑Ïî¨ Ïû¨ÏÉù ====================

-- Ïª∑Ïî¨ ÌÅêÏóê Ï∂îÍ∞Ä (chapterId: ÌÖåÎßà ÏÉâÏÉÅ Ï∞∏Ï°∞Ïö©)
function CutsceneController:QueueCutscene(
	lines: { { speaker: string?, text: string, characterId: string?, effect: string? } },
	title: string?,
	chapterId: string?
)
	self._currentChapterId = chapterId
	table.insert(self._cutsceneQueue, { lines = lines, title = title })
	if not self._isPlaying then
		self:_playNext()
	end
end

function CutsceneController:_playNext()
	if #self._cutsceneQueue == 0 then
		self:_hide()
		local pendingSkill = self._pendingSkillTutorial
		if pendingSkill and not self._shownSkillTutorials[pendingSkill] then
			self._pendingSkillTutorial = nil
			self._shownSkillTutorials[pendingSkill] = true
			task.delay(0.6, function()
				self:_showSkillTutorial(pendingSkill)
			end)
		end
		return
	end

	local cutscene = table.remove(self._cutsceneQueue, 1)
	self._currentLines = cutscene.lines
	self._currentLineIndex = 0
	self._isPlaying = true

	self:_show()
	self:_advanceLine()
end

function CutsceneController:_advanceLine()
	self._currentLineIndex += 1

	if self._currentLineIndex > #self._currentLines then
		task.delay(0.3, function()
			self._isPlaying = false
			self:_playNext()
		end)
		return
	end

	local line = self._currentLines[self._currentLineIndex]

	-- characterId Í∏∞Î∞ò Ï¥àÏÉÅÌôî/ÏÉâÏÉÅ ÏóÖÎç∞Ïù¥Ìä∏
	local characterId = line.characterId
	local profile = if characterId then ScenarioConstants.CHARACTER_PROFILES[characterId] else nil

	if profile then
		self:_updatePortrait(profile)
		if self._speakerLabel then
			self._speakerLabel.Text = profile.emoji .. " " .. profile.name
		end
		if self._speakerBg then
			TweenService:Create(self._speakerBg, TweenInfo.new(0.2), {
				BackgroundColor3 = profile.bgColor,
			}):Play()
		end
		self:_updateBorderColor(profile.role)
	elseif line.speaker then
		-- ÌïòÏúÑÌò∏Ìôò: speaker Î¨∏ÏûêÏó¥ Í∑∏ÎåÄÎ°ú ÌëúÏãú
		if self._speakerLabel then
			self._speakerLabel.Text = line.speaker
		end
	end

	-- Ïù¥ÌéôÌä∏ Ï≤òÎ¶¨
	local effect = line.effect
	if effect == "shake" then
		self:_shakePanel()
	elseif effect == "flash" then
		self:_flashPanel()
	elseif effect == "particle" then
		self:_showVictoryParticle()
	end

	if self._dialogueLabel then
		self._dialogueLabel.Text = ""
	end
	self:_typeText(line.text)
end

function CutsceneController:_typeText(text: string)
	if self._typingThread and coroutine.status(self._typingThread) == "suspended" then
		task.cancel(self._typingThread)
	end

	self._typingThread = task.spawn(function()
		local label = self._dialogueLabel
		if not label then
			return
		end

		local chars = string.len(text)
		for i = 1, chars do
			label.Text = string.sub(text, 1, i)
			task.wait(0.03)
		end
		self._typingThread = nil
	end)
end

function CutsceneController:_onNextPressed()
	if self._typingThread then
		if coroutine.status(self._typingThread) ~= "dead" then
			task.cancel(self._typingThread)
			self._typingThread = nil
		end
		local line = self._currentLines[self._currentLineIndex]
		if self._dialogueLabel and line then
			self._dialogueLabel.Text = line.text
		end
		return
	end
	self:_advanceLine()
end

function CutsceneController:_skipAll()
	if self._typingThread then
		task.cancel(self._typingThread)
		self._typingThread = nil
	end
	self._cutsceneQueue = {}
	self._isPlaying = false
	self:_hide()
	local pendingSkill = self._pendingSkillTutorial
	if pendingSkill and not self._shownSkillTutorials[pendingSkill] then
		self._pendingSkillTutorial = nil
		self._shownSkillTutorials[pendingSkill] = true
		task.delay(0.6, function()
			self:_showSkillTutorial(pendingSkill)
		end)
	end
end

-- ==================== Ï¥àÏÉÅÌôî ÏóÖÎç∞Ïù¥Ìä∏ ====================

function CutsceneController:_updatePortrait(profile: { id: string, name: string, emoji: string, role: string, bgColor: Color3, textColor: Color3 })
	local portraitFrame = self._portraitFrame
	local portraitEmoji = self._portraitEmoji
	if not portraitFrame or not portraitEmoji then
		return
	end

	-- Î∞∞Í≤ΩÏÉâ Ìä∏Ïúà
	TweenService:Create(portraitFrame, TweenInfo.new(0.2), {
		BackgroundColor3 = profile.bgColor,
	}):Play()

	-- Ïù¥Î™®ÏßÄ Î≥ÄÍ≤Ω + Ìåù Ïï†ÎãàÎ©îÏù¥ÏÖò
	portraitEmoji.Text = profile.emoji
	portraitFrame.Size = UDim2.new(0, 50, 0, 50)
	TweenService:Create(portraitFrame, TweenInfo.new(0.2, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
		Size = UDim2.new(0, 60, 0, 60),
	}):Play()

	-- ÌÖåÎëêÎ¶¨ ÏÉâÏÉÅ (Ïó≠Ìï†Î≥Ñ)
	local stroke = portraitFrame:FindFirstChildOfClass("UIStroke")
	if stroke then
		stroke.Color = ROLE_COLORS[profile.role] or Color3.fromRGB(200, 200, 200)
	end
end

function CutsceneController:_updateBorderColor(role: string)
	local topBorder = self._topBorder
	if not topBorder then
		return
	end
	local color = ROLE_COLORS[role] or Color3.fromRGB(100, 180, 255)
	TweenService:Create(topBorder, TweenInfo.new(0.2), {
		BackgroundColor3 = color,
	}):Play()
end

-- ==================== Ïù¥ÌéôÌä∏ ====================

-- Î≥¥Ïä§ Îì±Ïû• Ïãú Ìå®ÎÑê Ï¢åÏö∞ ÌùîÎì§Î¶º
function CutsceneController:_shakePanel()
	local panel = self._panel
	if not panel then
		return
	end

	local originalPos = UDim2.new(0, 0, 0.72, 0)
	if self._topBorder then
		self._topBorder.BackgroundColor3 = Color3.fromRGB(255, 30, 30)
	end

	task.spawn(function()
		for i = 1, 3 do
			local offsetX = if i % 2 == 1 then 6 else -6
			TweenService:Create(panel, TweenInfo.new(0.06), {
				Position = UDim2.new(0, offsetX, 0.72, 0),
			}):Play()
			task.wait(0.06)
		end
		TweenService:Create(panel, TweenInfo.new(0.06), {
			Position = originalPos,
		}):Play()
	end)
end

-- Îπ®Í∞Ñ ÌîåÎûòÏãú Ïù¥ÌéôÌä∏
function CutsceneController:_flashPanel()
	local panel = self._panel
	if not panel then
		return
	end

	local flashFrame = Instance.new("Frame")
	flashFrame.Size = UDim2.new(1, 0, 1, 0)
	flashFrame.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
	flashFrame.BackgroundTransparency = 0.5
	flashFrame.ZIndex = 10
	flashFrame.BorderSizePixel = 0
	flashFrame.Parent = panel

	TweenService:Create(flashFrame, TweenInfo.new(0.4), {
		BackgroundTransparency = 1,
	}):Play()

	task.delay(0.5, function()
		if flashFrame.Parent then
			flashFrame:Destroy()
		end
	end)
end

-- ÏäπÎ¶¨ Ìô©Í∏à ÌååÌã∞ÌÅ¥ Ïù¥ÌéôÌä∏
function CutsceneController:_showVictoryParticle()
	local gui = self._gui
	if not gui then
		return
	end

	for _ = 1, 8 do
		local particle = Instance.new("Frame")
		particle.Size = UDim2.new(0, math.random(8, 16), 0, math.random(8, 16))
		particle.Position = UDim2.new(0.5, 0, 0.75, 0)
		particle.BackgroundColor3 = Color3.fromRGB(255, math.random(180, 230), math.random(0, 80))
		particle.Rotation = math.random(0, 360)
		particle.ZIndex = 15
		particle.BorderSizePixel = 0
		particle.Parent = gui

		local cornerR = Instance.new("UICorner")
		cornerR.CornerRadius = UDim.new(0, 4)
		cornerR.Parent = particle

		local targetX = 0.5 + (math.random() - 0.5) * 1.2
		local targetY = 0.3 + math.random() * 0.5

		TweenService:Create(particle, TweenInfo.new(1.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
			Position = UDim2.new(targetX, 0, targetY, 0),
			BackgroundTransparency = 1,
			Rotation = math.random(180, 720),
		}):Play()

		task.delay(1.3, function()
			if particle.Parent then
				particle:Destroy()
			end
		end)
	end
end

-- ==================== ÌëúÏãú/Ïà®Í∏∞Í∏∞ ====================

function CutsceneController:_show()
	local gui = self._gui
	local panel = self._panel
	if not gui or not panel then
		return
	end

	gui.Enabled = true
	panel.Position = UDim2.new(0, 0, 1, 0)
	TweenService:Create(panel, TweenInfo.new(0.35, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
		Position = UDim2.new(0, 0, 0.72, 0),
	}):Play()
end

function CutsceneController:_hide()
	local gui = self._gui
	local panel = self._panel
	if not gui or not panel then
		return
	end

	TweenService:Create(panel, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
		Position = UDim2.new(0, 0, 1, 0),
	}):Play()

	task.delay(0.3, function()
		gui.Enabled = false
	end)
end

-- ==================== Ïä§ÌÇ¨ ÌäúÌÜ†Î¶¨Ïñº Ïò§Î≤ÑÎ†àÏù¥ ====================

function CutsceneController:_showSkillTutorial(skillId: string)
	local info = SKILL_TUTORIAL[skillId]
	if not info then
		return
	end

	local playerGui = self._player:WaitForChild("PlayerGui")

	local tutGui = Instance.new("ScreenGui")
	tutGui.Name = "SkillTutorialGui"
	tutGui.ResetOnSpawn = false
	tutGui.DisplayOrder = 22
	tutGui.Parent = playerGui

	local dimBg = Instance.new("TextButton")
	dimBg.Size = UDim2.new(1, 0, 1, 0)
	dimBg.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
	dimBg.BackgroundTransparency = 0.5
	dimBg.Text = ""
	dimBg.AutoButtonColor = false
	dimBg.Parent = tutGui

	local card = Instance.new("Frame")
	card.Name = "SkillCard"
	card.Size = UDim2.new(0, 300, 0, 196)
	card.Position = UDim2.new(0.5, -150, 0.5, -98)
	card.BackgroundColor3 = Color3.fromRGB(14, 18, 36)
	card.BorderSizePixel = 0
	card.Parent = tutGui

	local cardCorner = Instance.new("UICorner")
	cardCorner.CornerRadius = UDim.new(0, 16)
	cardCorner.Parent = card

	local cardStroke = Instance.new("UIStroke")
	cardStroke.Color = Color3.fromRGB(160, 100, 255)
	cardStroke.Thickness = 2
	cardStroke.Parent = card

	local badge = Instance.new("Frame")
	badge.Size = UDim2.new(0, 130, 0, 24)
	badge.Position = UDim2.new(0.5, -65, 0, -12)
	badge.BackgroundColor3 = Color3.fromRGB(140, 80, 240)
	badge.BorderSizePixel = 0
	badge.Parent = tutGui

	local badgeCorner = Instance.new("UICorner")
	badgeCorner.CornerRadius = UDim.new(0, 12)
	badgeCorner.Parent = badge

	local badgeLabel = Instance.new("TextLabel")
	badgeLabel.Size = UDim2.new(1, 0, 1, 0)
	badgeLabel.BackgroundTransparency = 1
	badgeLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
	badgeLabel.TextSize = 12
	badgeLabel.Font = Enum.Font.GothamBold
	badgeLabel.Text = "üåü ÏÉà Ïä§ÌÇ¨ ÌöçÎìù!"
	badgeLabel.Parent = badge

	local iconBg = Instance.new("Frame")
	iconBg.Size = UDim2.new(0, 64, 0, 64)
	iconBg.Position = UDim2.new(0.5, -32, 0, 18)
	iconBg.BackgroundColor3 = Color3.fromRGB(30, 20, 60)
	iconBg.BorderSizePixel = 0
	iconBg.Parent = card

	local iconBgCorner = Instance.new("UICorner")
	iconBgCorner.CornerRadius = UDim.new(0, 12)
	iconBgCorner.Parent = iconBg

	local iconStroke = Instance.new("UIStroke")
	iconStroke.Color = Color3.fromRGB(160, 100, 255)
	iconStroke.Thickness = 2
	iconStroke.Parent = iconBg

	local iconLabel = Instance.new("TextLabel")
	iconLabel.Size = UDim2.new(1, 0, 1, 0)
	iconLabel.BackgroundTransparency = 1
	iconLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
	iconLabel.TextSize = 32
	iconLabel.Font = Enum.Font.GothamBold
	iconLabel.Text = info.icon
	iconLabel.Parent = iconBg

	local nameLabel = Instance.new("TextLabel")
	nameLabel.Size = UDim2.new(1, -20, 0, 24)
	nameLabel.Position = UDim2.new(0, 10, 0, 88)
	nameLabel.BackgroundTransparency = 1
	nameLabel.TextColor3 = Color3.fromRGB(210, 170, 255)
	nameLabel.TextSize = 18
	nameLabel.Font = Enum.Font.GothamBlack
	nameLabel.Text = info.name
	nameLabel.Parent = card

	local howtoLabel = Instance.new("TextLabel")
	howtoLabel.Size = UDim2.new(1, -24, 0, 34)
	howtoLabel.Position = UDim2.new(0, 12, 0, 116)
	howtoLabel.BackgroundTransparency = 1
	howtoLabel.TextColor3 = Color3.fromRGB(220, 225, 240)
	howtoLabel.TextSize = 13
	howtoLabel.Font = Enum.Font.Gotham
	howtoLabel.Text = info.howto
	howtoLabel.TextWrapped = true
	howtoLabel.TextXAlignment = Enum.TextXAlignment.Center
	howtoLabel.Parent = card

	local tipLabel = Instance.new("TextLabel")
	tipLabel.Size = UDim2.new(1, -24, 0, 22)
	tipLabel.Position = UDim2.new(0, 12, 0, 150)
	tipLabel.BackgroundTransparency = 1
	tipLabel.TextColor3 = Color3.fromRGB(160, 200, 140)
	tipLabel.TextSize = 11
	tipLabel.Font = Enum.Font.Gotham
	tipLabel.Text = info.tip
	tipLabel.Parent = card

	local dismissBtn = Instance.new("TextButton")
	dismissBtn.Size = UDim2.new(1, -24, 0, 32)
	dismissBtn.Position = UDim2.new(0, 12, 1, -40)
	dismissBtn.BackgroundColor3 = Color3.fromRGB(100, 60, 200)
	dismissBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
	dismissBtn.TextSize = 14
	dismissBtn.Font = Enum.Font.GothamBold
	dismissBtn.Text = "ÌôïÏù∏! (6)"
	dismissBtn.Parent = card

	local dismissCorner = Instance.new("UICorner")
	dismissCorner.CornerRadius = UDim.new(0, 8)
	dismissCorner.Parent = dismissBtn

	-- Îì±Ïû• Ïï†ÎãàÎ©îÏù¥ÏÖò
	card.Position = UDim2.new(0.5, -150, 0.5, -58)
	card.BackgroundTransparency = 1
	TweenService:Create(card, TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
		Position = UDim2.new(0.5, -150, 0.5, -98),
		BackgroundTransparency = 0,
	}):Play()

	local function closeTutorial()
		TweenService:Create(card, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
			Position = UDim2.new(0.5, -150, 0.5, -68),
			BackgroundTransparency = 1,
		}):Play()
		task.delay(0.25, function()
			if tutGui.Parent then
				tutGui:Destroy()
			end
		end)
	end

	dimBg.MouseButton1Click:Connect(closeTutorial)
	dismissBtn.MouseButton1Click:Connect(closeTutorial)

	task.spawn(function()
		for i = 5, 1, -1 do
			task.wait(1)
			if not dismissBtn.Parent then
				return
			end
			dismissBtn.Text = `ÌôïÏù∏! ({i})`
		end
		task.wait(1)
		if tutGui.Parent then
			closeTutorial()
		end
	end)
end

return CutsceneController
