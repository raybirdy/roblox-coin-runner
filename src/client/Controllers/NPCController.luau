--!strict
-- NPC Controller
-- NPC ë§í’ì„  ë° ì• ë‹ˆë©”ì´ì…˜ í‘œì‹œ (í´ë¼ì´ì–¸íŠ¸)

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local GameConstants = require(ReplicatedStorage.Shared.Constants.GameConstants)
local RemoteEvents = require(ReplicatedStorage.Shared.RemoteEvents)

local NPCController = {}
NPCController.__index = NPCController

export type NPCController = typeof(setmetatable(
	{} :: {
		_player: Player,
		_playerGui: PlayerGui,
		_tutorialGui: ScreenGui?,
		_connections: { RBXScriptConnection },
	},
	NPCController
))

function NPCController.new(): NPCController
	local player = Players.LocalPlayer
	local self = setmetatable({
		_player = player,
		_playerGui = player:WaitForChild("PlayerGui") :: PlayerGui,
		_tutorialGui = nil,
		_connections = {},
	}, NPCController)

	self:_setupEventHandlers()
	self:_createTutorialGui()

	return self
end

-- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì„¤ì •
function NPCController:_setupEventHandlers()
	-- NPC ë“±ì¥ ì´ë²¤íŠ¸ ìˆ˜ì‹ 
	local npcAppearedConnection = RemoteEvents.NPCAppeared.OnClientEvent:Connect(function(data)
		self:OnNPCAppeared(data.npcType, data.position, data.npcInstance, data.messageIndex)
	end)
	table.insert(self._connections, npcAppearedConnection)

	print("[NPCController] Event handlers set up")
end

-- NPC ë“±ì¥ ì²˜ë¦¬
function NPCController:OnNPCAppeared(
	npcType: string,
	position: Vector3,
	npcInstance: Model,
	messageIndex: number?
)
	print(`[NPCController] NPC appeared: {npcType} at {position}`)

	-- ë§í’ì„  í‘œì‹œ
	self:ShowSpeechBubble(npcInstance, npcType, messageIndex)
end

-- ë§í’ì„  í‘œì‹œ
function NPCController:ShowSpeechBubble(npcModel: Model, npcType: string, messageIndex: number?)
	local TweenService = game:GetService("TweenService")
	local npcConfig = GameConstants.NPC.TYPES[npcType]
	if not npcConfig then
		return
	end

	-- ëœë¤ ë©”ì‹œì§€ ì„ íƒ (ë˜ëŠ” ì§€ì •ëœ ì¸ë±ìŠ¤ ì‚¬ìš©)
	local message
	if messageIndex and npcConfig.messages[messageIndex] then
		message = npcConfig.messages[messageIndex]
	else
		message = npcConfig.messages[math.random(1, #npcConfig.messages)]
	end

	-- ë§í’ì„  ìƒì„±
	local head = npcModel:FindFirstChild("Head") :: BasePart?
	if not head then
		return
	end

	-- BillboardGui ìƒì„±
	local billboardGui = Instance.new("BillboardGui")
	billboardGui.Name = "SpeechBubble"
	billboardGui.Size = UDim2.new(0, 250, 0, 80) -- ë” í¬ê²Œ
	billboardGui.StudsOffset = Vector3.new(0, 4, 0) -- ë” ë†’ì´
	billboardGui.Adornee = head
	billboardGui.AlwaysOnTop = true
	billboardGui.Parent = head

	-- ë§í’ì„  ë°°ê²½ (í”„ë ˆì„)
	local frame = Instance.new("Frame")
	frame.Name = "BubbleFrame"
	frame.Size = UDim2.new(1, 0, 1, 0)
	frame.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
	frame.BackgroundTransparency = 0.1
	frame.Parent = billboardGui

	-- ë‘¥ê·¼ ëª¨ì„œë¦¬
	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0, 16)
	corner.Parent = frame

	-- NPC ìƒ‰ìƒ í…Œë‘ë¦¬
	local stroke = Instance.new("UIStroke")
	stroke.Color = npcConfig.color
	stroke.Thickness = 4
	stroke.Parent = frame

	-- ì´ëª¨ì§€ (NPC ì¢…ë¥˜ì— ë”°ë¼)
	local emoji = npcType == "Rabbit" and "ğŸ°" or (npcType == "Bear" and "ğŸ»" or "ğŸ¦‰")

	-- í…ìŠ¤íŠ¸
	local textLabel = Instance.new("TextLabel")
	textLabel.Size = UDim2.new(1, -20, 1, -10)
	textLabel.Position = UDim2.new(0, 10, 0, 5)
	textLabel.BackgroundTransparency = 1
	textLabel.Text = `{emoji} {message}`
	textLabel.TextColor3 = Color3.fromRGB(50, 50, 50)
	textLabel.TextSize = 22
	textLabel.Font = Enum.Font.GothamBold
	textLabel.TextWrapped = true
	textLabel.Parent = frame

	-- ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜
	billboardGui.Size = UDim2.new(0, 0, 0, 0)
	local appearTween = TweenService:Create(billboardGui, TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
		Size = UDim2.new(0, 250, 0, 80),
	})
	appearTween:Play()

	-- ì¼ì • ì‹œê°„ í›„ ë§í’ì„  ì œê±° (ì‚¬ë¼ì§€ëŠ” ì• ë‹ˆë©”ì´ì…˜)
	task.delay(GameConstants.NPC.SPEECH_BUBBLE_DURATION - 0.3, function()
		if billboardGui and billboardGui.Parent then
			local disappearTween = TweenService:Create(billboardGui, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
				Size = UDim2.new(0, 0, 0, 0),
			})
			disappearTween:Play()
			disappearTween.Completed:Connect(function()
				if billboardGui and billboardGui.Parent then
					billboardGui:Destroy()
				end
			end)
		end
	end)

	print(`[NPCController] Displayed speech bubble: "{emoji} {message}"`)
end

-- íŠœí† ë¦¬ì–¼ GUI ìƒì„±
function NPCController:_createTutorialGui()
	local tutorialGui = Instance.new("ScreenGui")
	tutorialGui.Name = "TutorialGui"
	tutorialGui.ResetOnSpawn = false
	tutorialGui.Enabled = false
	tutorialGui.Parent = self._playerGui
	self._tutorialGui = tutorialGui

	-- ë¶€ì—‰ì´ ì•„ì´ì½˜ (ì™¼ìª½ ìƒë‹¨)
	local owlIcon = Instance.new("Frame")
	owlIcon.Name = "OwlIcon"
	owlIcon.Size = UDim2.new(0, 80, 0, 80)
	owlIcon.Position = UDim2.new(0, 20, 0, 120)
	owlIcon.BackgroundColor3 = GameConstants.NPC.TYPES.Owl.color
	owlIcon.BackgroundTransparency = 0.2
	owlIcon.Parent = tutorialGui

	local owlCorner = Instance.new("UICorner")
	owlCorner.CornerRadius = UDim.new(1, 0) -- ì›í˜•
	owlCorner.Parent = owlIcon

	-- ë¶€ì—‰ì´ ì´ëª¨ì§€
	local owlEmoji = Instance.new("TextLabel")
	owlEmoji.Size = UDim2.new(1, 0, 1, 0)
	owlEmoji.BackgroundTransparency = 1
	owlEmoji.Text = "ğŸ¦‰"
	owlEmoji.TextSize = 48
	owlEmoji.Parent = owlIcon

	-- ë©”ì‹œì§€ í”„ë ˆì„
	local messageFrame = Instance.new("Frame")
	messageFrame.Name = "MessageFrame"
	messageFrame.Size = UDim2.new(0, 300, 0, 80)
	messageFrame.Position = UDim2.new(0, 110, 0, 130)
	messageFrame.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
	messageFrame.BackgroundTransparency = 0.1
	messageFrame.Parent = tutorialGui

	local messageCorner = Instance.new("UICorner")
	messageCorner.CornerRadius = UDim.new(0, 12)
	messageCorner.Parent = messageFrame

	local messageStroke = Instance.new("UIStroke")
	messageStroke.Color = Color3.fromRGB(160, 82, 45)
	messageStroke.Thickness = 3
	messageStroke.Parent = messageFrame

	-- ë©”ì‹œì§€ í…ìŠ¤íŠ¸
	local messageLabel = Instance.new("TextLabel")
	messageLabel.Name = "MessageLabel"
	messageLabel.Size = UDim2.new(1, -20, 1, -20)
	messageLabel.Position = UDim2.new(0, 10, 0, 10)
	messageLabel.BackgroundTransparency = 1
	messageLabel.Text = ""
	messageLabel.TextColor3 = Color3.fromRGB(0, 0, 0)
	messageLabel.TextSize = 20
	messageLabel.Font = Enum.Font.GothamBold
	messageLabel.TextWrapped = true
	messageLabel.TextXAlignment = Enum.TextXAlignment.Left
	messageLabel.TextYAlignment = Enum.TextYAlignment.Center
	messageLabel.Parent = messageFrame

	print("[NPCController] Tutorial GUI created")
end

-- ë¶€ì—‰ì´ ë©”ì‹œì§€ í‘œì‹œ (íŠœí† ë¦¬ì–¼ìš©)
function NPCController:ShowOwlMessage(message: string)
	if not self._tutorialGui then
		return
	end

	-- GUI í™œì„±í™”
	self._tutorialGui.Enabled = true

	-- ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
	local messageLabel = self._tutorialGui.MessageFrame:FindFirstChild("MessageLabel") :: TextLabel?
	if messageLabel then
		messageLabel.Text = message
	end

	-- 3ì´ˆ í›„ ìˆ¨ê¹€
	task.delay(3, function()
		if self._tutorialGui then
			self._tutorialGui.Enabled = false
		end
	end)

	print(`[NPCController] Showed owl message: "{message}"`)
end

-- ì •ë¦¬
function NPCController:Destroy()
	for _, connection in self._connections do
		connection:Disconnect()
	end
	self._connections = {}
end

print("[NPCController] Initialized")

return NPCController
