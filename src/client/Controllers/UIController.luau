--!strict
-- UI Controller
-- ê²Œì„ UI ê´€ë¦¬ (ì ìˆ˜, ì½”ì¸, ë¼ì´í”„ í‘œì‹œ)

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")

local GameConstants = require(ReplicatedStorage.Shared.Constants.GameConstants)
local RemoteEvents = require(ReplicatedStorage.Shared.RemoteEvents)

local UIController = {}
UIController.__index = UIController

export type UIController = typeof(setmetatable(
	{} :: {
		_player: Player,
		_playerGui: PlayerGui,
		_screenGui: ScreenGui?,
		_scoreLabel: TextLabel?,
		_coinsLabel: TextLabel?,
		_livesLabel: TextLabel?,
		_livesContainer: Frame?,
		_heartLabels: { TextLabel },
		_currentLives: number,
		_distanceLabel: TextLabel?,
		_gameOverFrame: Frame?,
		_startMenuFrame: Frame?,
		_jumpButton: TextButton?,
		_slideButton: TextButton?,
		_tutorialBanner: Frame?, -- íŠœí† ë¦¬ì–¼ ë°°ë„ˆ
		_tutorialNotification: Frame?, -- íŠœí† ë¦¬ì–¼ ì¢…ë£Œ ì•Œë¦¼
		_countdownLabel: TextLabel?, -- ì¹´ìš´íŠ¸ë‹¤ìš´ í‘œì‹œ
		_connections: { RBXScriptConnection },
		_onJumpCallback: (() -> ())?,
		_onSlideCallback: (() -> ())?,
	},
	UIController
))

function UIController.new(player: Player): UIController
	local self = setmetatable({
		_player = player,
		_playerGui = player:WaitForChild("PlayerGui") :: PlayerGui,
		_screenGui = nil,
		_scoreLabel = nil,
		_coinsLabel = nil,
		_livesLabel = nil,
		_livesContainer = nil,
		_heartLabels = {},
		_currentLives = GameConstants.LIFE.STARTING_LIVES,
		_distanceLabel = nil,
		_gameOverFrame = nil,
		_startMenuFrame = nil,
		_jumpButton = nil,
		_slideButton = nil,
		_tutorialBanner = nil,
		_tutorialNotification = nil,
		_countdownLabel = nil,
		_connections = {},
		_onJumpCallback = nil,
		_onSlideCallback = nil,
	}, UIController)

	self:_createUI()
	self:_createMobileControls()
	self:_setupEventHandlers()
	self:ShowStartMenu() -- ì‹œì‘ ì‹œ ë©”ë‰´ í‘œì‹œ

	return self
end

-- UI ìƒì„±
function UIController:_createUI()
	-- ScreenGui ìƒì„±
	local screenGui = Instance.new("ScreenGui")
	screenGui.Name = "GameUI"
	screenGui.ResetOnSpawn = false
	screenGui.Parent = self._playerGui
	self._screenGui = screenGui

	-- ì ìˆ˜ í‘œì‹œ (ìƒë‹¨ ì¤‘ì•™)
	local scoreLabel = Instance.new("TextLabel")
	scoreLabel.Name = "ScoreLabel"
	scoreLabel.Size = UDim2.new(0, 200, 0, 50)
	scoreLabel.Position = UDim2.new(0.5, -100, 0, 10)
	scoreLabel.BackgroundTransparency = 0.3
	scoreLabel.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
	scoreLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
	scoreLabel.TextSize = 24
	scoreLabel.Font = Enum.Font.GothamBold
	scoreLabel.Text = "Score: 0"
	scoreLabel.Parent = screenGui
	self._scoreLabel = scoreLabel

	-- ë‘¥ê·¼ ëª¨ì„œë¦¬
	local scoreCorner = Instance.new("UICorner")
	scoreCorner.CornerRadius = UDim.new(0, 8)
	scoreCorner.Parent = scoreLabel

	-- ì½”ì¸ í‘œì‹œ (ìƒë‹¨ ì™¼ìª½)
	local coinsLabel = Instance.new("TextLabel")
	coinsLabel.Name = "CoinsLabel"
	coinsLabel.Size = UDim2.new(0, 150, 0, 40)
	coinsLabel.Position = UDim2.new(0, 10, 0, 10)
	coinsLabel.BackgroundTransparency = 0.3
	coinsLabel.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
	coinsLabel.TextColor3 = Color3.fromRGB(255, 215, 0) -- ê¸ˆìƒ‰
	coinsLabel.TextSize = 20
	coinsLabel.Font = Enum.Font.GothamBold
	coinsLabel.Text = "ğŸª™ 0"
	coinsLabel.Parent = screenGui
	self._coinsLabel = coinsLabel

	-- ë‘¥ê·¼ ëª¨ì„œë¦¬
	local coinsCorner = Instance.new("UICorner")
	coinsCorner.CornerRadius = UDim.new(0, 8)
	coinsCorner.Parent = coinsLabel

	-- ë¼ì´í”„ ì»¨í…Œì´ë„ˆ (ìƒë‹¨ ì˜¤ë¥¸ìª½)
	local livesContainer = Instance.new("Frame")
	livesContainer.Name = "LivesContainer"
	livesContainer.Size = UDim2.new(0, 150, 0, 50)
	livesContainer.Position = UDim2.new(1, -160, 0, 10)
	livesContainer.BackgroundTransparency = 0.3
	livesContainer.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
	livesContainer.Parent = screenGui
	self._livesContainer = livesContainer

	-- ë‘¥ê·¼ ëª¨ì„œë¦¬
	local livesCorner = Instance.new("UICorner")
	livesCorner.CornerRadius = UDim.new(0, 8)
	livesCorner.Parent = livesContainer

	-- ê°œë³„ í•˜íŠ¸ ìƒì„±
	self._heartLabels = {}
	for i = 1, GameConstants.LIFE.STARTING_LIVES do
		local heart = Instance.new("TextLabel")
		heart.Name = `Heart{i}`
		heart.Size = UDim2.new(0, 40, 0, 40)
		heart.Position = UDim2.new(0, 10 + (i - 1) * 45, 0.5, -20)
		heart.BackgroundTransparency = 1
		heart.TextColor3 = Color3.fromRGB(255, 50, 50)
		heart.TextSize = 32
		heart.Font = Enum.Font.GothamBold
		heart.Text = "â¤ï¸"
		heart.Parent = livesContainer
		table.insert(self._heartLabels, heart)
	end

	-- ê¸°ì¡´ livesLabelì€ ìˆ¨ê¹€ ì²˜ë¦¬ (í˜¸í™˜ì„±)
	local livesLabel = Instance.new("TextLabel")
	livesLabel.Name = "LivesLabel"
	livesLabel.Visible = false
	livesLabel.Parent = screenGui
	self._livesLabel = livesLabel

	-- ê±°ë¦¬ í‘œì‹œ (ì ìˆ˜ ì•„ë˜)
	local distanceLabel = Instance.new("TextLabel")
	distanceLabel.Name = "DistanceLabel"
	distanceLabel.Size = UDim2.new(0, 200, 0, 40)
	distanceLabel.Position = UDim2.new(0.5, -100, 0, 65)
	distanceLabel.BackgroundTransparency = 0.3
	distanceLabel.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
	distanceLabel.TextColor3 = Color3.fromRGB(100, 200, 255) -- íŒŒë€ìƒ‰
	distanceLabel.TextSize = 18
	distanceLabel.Font = Enum.Font.Gotham
	distanceLabel.Text = "Distance: 0m"
	distanceLabel.Parent = screenGui
	self._distanceLabel = distanceLabel

	-- ë‘¥ê·¼ ëª¨ì„œë¦¬
	local distanceCorner = Instance.new("UICorner")
	distanceCorner.CornerRadius = UDim.new(0, 8)
	distanceCorner.Parent = distanceLabel

	-- ê²Œì„ ì˜¤ë²„ í”„ë ˆì„ (ì´ˆê¸° ìˆ¨ê¹€)
	local gameOverFrame = Instance.new("Frame")
	gameOverFrame.Name = "GameOverFrame"
	gameOverFrame.Size = UDim2.new(0, 450, 0, 480)
	gameOverFrame.Position = UDim2.new(0.5, -225, 0.5, -240)
	gameOverFrame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
	gameOverFrame.BackgroundTransparency = 0.15
	gameOverFrame.Visible = false
	gameOverFrame.Parent = screenGui
	self._gameOverFrame = gameOverFrame

	-- ë‘¥ê·¼ ëª¨ì„œë¦¬
	local gameOverCorner = Instance.new("UICorner")
	gameOverCorner.CornerRadius = UDim.new(0, 20)
	gameOverCorner.Parent = gameOverFrame

	-- í…Œë‘ë¦¬
	local gameOverStroke = Instance.new("UIStroke")
	gameOverStroke.Color = Color3.fromRGB(255, 255, 255)
	gameOverStroke.Thickness = 3
	gameOverStroke.Transparency = 0.3
	gameOverStroke.Parent = gameOverFrame

	-- ê²Œì„ ì˜¤ë²„ í…ìŠ¤íŠ¸
	local gameOverTitle = Instance.new("TextLabel")
	gameOverTitle.Name = "Title"
	gameOverTitle.Size = UDim2.new(1, 0, 0, 60)
	gameOverTitle.Position = UDim2.new(0, 0, 0, 20)
	gameOverTitle.BackgroundTransparency = 1
	gameOverTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
	gameOverTitle.TextSize = 42
	gameOverTitle.Font = Enum.Font.GothamBold
	gameOverTitle.Text = "GAME OVER"
	gameOverTitle.Parent = gameOverFrame

	-- NEW RECORD ë°°ì§€ (ì´ˆê¸° ìˆ¨ê¹€)
	local newRecordLabel = Instance.new("TextLabel")
	newRecordLabel.Name = "NewRecord"
	newRecordLabel.Size = UDim2.new(0, 200, 0, 40)
	newRecordLabel.Position = UDim2.new(0.5, -100, 0, 75)
	newRecordLabel.BackgroundColor3 = Color3.fromRGB(255, 215, 0)
	newRecordLabel.BackgroundTransparency = 0.1
	newRecordLabel.TextColor3 = Color3.fromRGB(0, 0, 0)
	newRecordLabel.TextSize = 22
	newRecordLabel.Font = Enum.Font.GothamBold
	newRecordLabel.Text = "ğŸ‰ NEW RECORD! ğŸ‰"
	newRecordLabel.Visible = false
	newRecordLabel.Parent = gameOverFrame

	local newRecordCorner = Instance.new("UICorner")
	newRecordCorner.CornerRadius = UDim.new(0, 8)
	newRecordCorner.Parent = newRecordLabel

	-- ìµœì¢… ì ìˆ˜
	local finalScoreLabel = Instance.new("TextLabel")
	finalScoreLabel.Name = "FinalScore"
	finalScoreLabel.Size = UDim2.new(1, 0, 0, 50)
	finalScoreLabel.Position = UDim2.new(0, 0, 0, 130)
	finalScoreLabel.BackgroundTransparency = 1
	finalScoreLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
	finalScoreLabel.TextSize = 32
	finalScoreLabel.Font = Enum.Font.GothamBold
	finalScoreLabel.Text = "Score: 0"
	finalScoreLabel.Parent = gameOverFrame

	-- ê±°ë¦¬ í‘œì‹œ
	local distanceLabel = Instance.new("TextLabel")
	distanceLabel.Name = "Distance"
	distanceLabel.Size = UDim2.new(1, 0, 0, 35)
	distanceLabel.Position = UDim2.new(0, 0, 0, 180)
	distanceLabel.BackgroundTransparency = 1
	distanceLabel.TextColor3 = Color3.fromRGB(100, 200, 255)
	distanceLabel.TextSize = 20
	distanceLabel.Font = Enum.Font.Gotham
	distanceLabel.Text = "ğŸƒ Distance: 0m"
	distanceLabel.Parent = gameOverFrame

	-- íšë“ ì½”ì¸
	local earnedCoinsLabel = Instance.new("TextLabel")
	earnedCoinsLabel.Name = "EarnedCoins"
	earnedCoinsLabel.Size = UDim2.new(1, 0, 0, 35)
	earnedCoinsLabel.Position = UDim2.new(0, 0, 0, 220)
	earnedCoinsLabel.BackgroundTransparency = 1
	earnedCoinsLabel.TextColor3 = Color3.fromRGB(255, 215, 0)
	earnedCoinsLabel.TextSize = 20
	earnedCoinsLabel.Font = Enum.Font.Gotham
	earnedCoinsLabel.Text = "ğŸª™ Coins: 0"
	earnedCoinsLabel.Parent = gameOverFrame

	-- ìµœê³  ì ìˆ˜
	local highScoreLabel = Instance.new("TextLabel")
	highScoreLabel.Name = "HighScore"
	highScoreLabel.Size = UDim2.new(1, 0, 0, 40)
	highScoreLabel.Position = UDim2.new(0, 0, 0, 270)
	highScoreLabel.BackgroundTransparency = 1
	highScoreLabel.TextColor3 = Color3.fromRGB(255, 200, 0)
	highScoreLabel.TextSize = 24
	highScoreLabel.Font = Enum.Font.GothamBold
	highScoreLabel.Text = "ğŸ† High Score: 0"
	highScoreLabel.Parent = gameOverFrame

	-- ì¬ì‹œì‘ ë²„íŠ¼
	local restartButton = Instance.new("TextButton")
	restartButton.Name = "RestartButton"
	restartButton.Size = UDim2.new(0, 280, 0, 70)
	restartButton.Position = UDim2.new(0.5, -140, 0, 340)
	restartButton.BackgroundColor3 = Color3.fromRGB(0, 180, 0)
	restartButton.TextColor3 = Color3.fromRGB(255, 255, 255)
	restartButton.TextSize = 32
	restartButton.Font = Enum.Font.GothamBold
	restartButton.Text = "â–¶ PLAY AGAIN"
	restartButton.Parent = gameOverFrame

	-- ë‘¥ê·¼ ëª¨ì„œë¦¬
	local restartCorner = Instance.new("UICorner")
	restartCorner.CornerRadius = UDim.new(0, 16)
	restartCorner.Parent = restartButton

	-- ë²„íŠ¼ í…Œë‘ë¦¬
	local restartStroke = Instance.new("UIStroke")
	restartStroke.Color = Color3.fromRGB(255, 255, 255)
	restartStroke.Thickness = 2
	restartStroke.Transparency = 0.5
	restartStroke.Parent = restartButton

	-- ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
	restartButton.MouseButton1Click:Connect(function()
		self:OnRestartButtonClicked()
	end)

	-- ì‹œì‘ ë©”ë‰´ í”„ë ˆì„ (ì´ˆê¸° í™”ë©´)
	local startMenuFrame = Instance.new("Frame")
	startMenuFrame.Name = "StartMenuFrame"
	startMenuFrame.Size = UDim2.new(0, 500, 0, 400)
	startMenuFrame.Position = UDim2.new(0.5, -250, 0.5, -200)
	startMenuFrame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
	startMenuFrame.BackgroundTransparency = 0.3
	startMenuFrame.Visible = false
	startMenuFrame.Parent = screenGui
	self._startMenuFrame = startMenuFrame

	-- ê²Œì„ íƒ€ì´í‹€
	local titleLabel = Instance.new("TextLabel")
	titleLabel.Name = "Title"
	titleLabel.Size = UDim2.new(1, 0, 0, 80)
	titleLabel.Position = UDim2.new(0, 0, 0, 30)
	titleLabel.BackgroundTransparency = 1
	titleLabel.TextColor3 = Color3.fromRGB(255, 215, 0)
	titleLabel.TextSize = 48
	titleLabel.Font = Enum.Font.GothamBold
	titleLabel.Text = "COIN RUNNER"
	titleLabel.Parent = startMenuFrame

	-- ë¶€ì œëª©
	local subtitleLabel = Instance.new("TextLabel")
	subtitleLabel.Name = "Subtitle"
	subtitleLabel.Size = UDim2.new(1, 0, 0, 30)
	subtitleLabel.Position = UDim2.new(0, 0, 0, 120)
	subtitleLabel.BackgroundTransparency = 1
	subtitleLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
	subtitleLabel.TextSize = 20
	subtitleLabel.Font = Enum.Font.Gotham
	subtitleLabel.Text = "Collect coins, dodge obstacles!"
	subtitleLabel.Parent = startMenuFrame

	-- í”Œë ˆì´ ë²„íŠ¼
	local playButton = Instance.new("TextButton")
	playButton.Name = "PlayButton"
	playButton.Size = UDim2.new(0, 250, 0, 60)
	playButton.Position = UDim2.new(0.5, -125, 0, 200)
	playButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
	playButton.TextColor3 = Color3.fromRGB(255, 255, 255)
	playButton.TextSize = 32
	playButton.Font = Enum.Font.GothamBold
	playButton.Text = "PLAY"
	playButton.Parent = startMenuFrame

	-- ë‘¥ê·¼ ëª¨ì„œë¦¬
	local playCorner = Instance.new("UICorner")
	playCorner.CornerRadius = UDim.new(0, 12)
	playCorner.Parent = playButton

	-- í”Œë ˆì´ ë²„íŠ¼ í´ë¦­
	playButton.MouseButton1Click:Connect(function()
		self:OnPlayButtonClicked()
	end)

	-- ì¡°ì‘ë²• ì•ˆë‚´
	local controlsLabel = Instance.new("TextLabel")
	controlsLabel.Name = "Controls"
	controlsLabel.Size = UDim2.new(1, 0, 0, 80)
	controlsLabel.Position = UDim2.new(0, 0, 0, 290)
	controlsLabel.BackgroundTransparency = 1
	controlsLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
	controlsLabel.TextSize = 16
	controlsLabel.Font = Enum.Font.Gotham
	controlsLabel.Text = "Controls:\nJUMP: Space / W / â†‘\nSLIDE: S / â†“"
	controlsLabel.Parent = startMenuFrame

	-- íŠœí† ë¦¬ì–¼ ë°°ë„ˆ (í™”ë©´ ìƒë‹¨)
	local tutorialBanner = Instance.new("Frame")
	tutorialBanner.Name = "TutorialBanner"
	tutorialBanner.Size = UDim2.new(0, 300, 0, 50)
	tutorialBanner.Position = UDim2.new(0.5, -150, 0, 120)
	tutorialBanner.BackgroundColor3 = Color3.fromRGB(50, 150, 255)
	tutorialBanner.BackgroundTransparency = 0.2
	tutorialBanner.Visible = false
	tutorialBanner.Parent = screenGui
	self._tutorialBanner = tutorialBanner

	local tutorialCorner = Instance.new("UICorner")
	tutorialCorner.CornerRadius = UDim.new(0, 12)
	tutorialCorner.Parent = tutorialBanner

	local tutorialStroke = Instance.new("UIStroke")
	tutorialStroke.Color = Color3.fromRGB(255, 255, 255)
	tutorialStroke.Thickness = 2
	tutorialStroke.Parent = tutorialBanner

	local tutorialLabel = Instance.new("TextLabel")
	tutorialLabel.Name = "Label"
	tutorialLabel.Size = UDim2.new(1, 0, 1, 0)
	tutorialLabel.BackgroundTransparency = 1
	tutorialLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
	tutorialLabel.TextSize = 22
	tutorialLabel.Font = Enum.Font.GothamBold
	tutorialLabel.Text = "ì—°ìŠµ ëª¨ë“œ"
	tutorialLabel.Parent = tutorialBanner

	-- íŠœí† ë¦¬ì–¼ ì¢…ë£Œ ì•Œë¦¼ (í™”ë©´ ì¤‘ì•™)
	local tutorialNotification = Instance.new("Frame")
	tutorialNotification.Name = "TutorialNotification"
	tutorialNotification.Size = UDim2.new(0, 400, 0, 100)
	tutorialNotification.Position = UDim2.new(0.5, -200, 0.4, -50)
	tutorialNotification.BackgroundColor3 = Color3.fromRGB(0, 200, 100)
	tutorialNotification.BackgroundTransparency = 0.1
	tutorialNotification.Visible = false
	tutorialNotification.Parent = screenGui
	self._tutorialNotification = tutorialNotification

	local notificationCorner = Instance.new("UICorner")
	notificationCorner.CornerRadius = UDim.new(0, 16)
	notificationCorner.Parent = tutorialNotification

	local notificationStroke = Instance.new("UIStroke")
	notificationStroke.Color = Color3.fromRGB(255, 255, 255)
	notificationStroke.Thickness = 3
	notificationStroke.Parent = tutorialNotification

	local notificationLabel = Instance.new("TextLabel")
	notificationLabel.Name = "Label"
	notificationLabel.Size = UDim2.new(1, 0, 1, 0)
	notificationLabel.BackgroundTransparency = 1
	notificationLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
	notificationLabel.TextSize = 28
	notificationLabel.Font = Enum.Font.GothamBold
	notificationLabel.Text = "ì—°ìŠµ ì™„ë£Œ! ê²Œì„ ì‹œì‘!"
	notificationLabel.Parent = tutorialNotification

	-- ì¹´ìš´íŠ¸ë‹¤ìš´ í‘œì‹œ (í™”ë©´ ì¤‘ì•™, í¬ê²Œ)
	local countdownLabel = Instance.new("TextLabel")
	countdownLabel.Name = "CountdownLabel"
	countdownLabel.Size = UDim2.new(0, 300, 0, 200)
	countdownLabel.Position = UDim2.new(0.5, -150, 0.5, -100)
	countdownLabel.BackgroundTransparency = 1
	countdownLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
	countdownLabel.TextSize = 120
	countdownLabel.Font = Enum.Font.GothamBold
	countdownLabel.Text = ""
	countdownLabel.TextStrokeTransparency = 0.3
	countdownLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
	countdownLabel.Visible = false
	countdownLabel.ZIndex = 100 -- ë‹¤ë¥¸ UI ìœ„ì— í‘œì‹œ
	countdownLabel.Parent = screenGui
	self._countdownLabel = countdownLabel

	print("[UIController] UI created")
end

-- ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ ìƒì„±
function UIController:_createMobileControls()
	if not self._screenGui then
		return
	end

	-- ì í”„ ë²„íŠ¼ (ì˜¤ë¥¸ìª½ í•˜ë‹¨)
	local jumpButton = Instance.new("TextButton")
	jumpButton.Name = "JumpButton"
	jumpButton.Size = UDim2.new(0, GameConstants.UI.TOUCH_BUTTON_SIZE, 0, GameConstants.UI.TOUCH_BUTTON_SIZE)
	jumpButton.Position = UDim2.new(1, -GameConstants.UI.TOUCH_BUTTON_SIZE - 20, 1, -GameConstants.UI.TOUCH_BUTTON_SIZE - 20)
	jumpButton.BackgroundColor3 = Color3.fromRGB(0, 150, 255) -- íŒŒë€ìƒ‰
	jumpButton.BackgroundTransparency = 0.3
	jumpButton.TextColor3 = Color3.fromRGB(255, 255, 255)
	jumpButton.TextSize = 32
	jumpButton.Font = Enum.Font.GothamBold
	jumpButton.Text = "â†‘\nJUMP"
	jumpButton.TextYAlignment = Enum.TextYAlignment.Center
	jumpButton.Parent = self._screenGui
	self._jumpButton = jumpButton

	-- ë‘¥ê·¼ ëª¨ì„œë¦¬
	local jumpCorner = Instance.new("UICorner")
	jumpCorner.CornerRadius = UDim.new(0, 12)
	jumpCorner.Parent = jumpButton

	-- í…Œë‘ë¦¬
	local jumpStroke = Instance.new("UIStroke")
	jumpStroke.Color = Color3.fromRGB(255, 255, 255)
	jumpStroke.Thickness = 2
	jumpStroke.Transparency = 0.5
	jumpStroke.Parent = jumpButton

	-- ìŠ¬ë¼ì´ë“œ ë²„íŠ¼ (ì™¼ìª½ í•˜ë‹¨)
	local slideButton = Instance.new("TextButton")
	slideButton.Name = "SlideButton"
	slideButton.Size = UDim2.new(0, GameConstants.UI.TOUCH_BUTTON_SIZE, 0, GameConstants.UI.TOUCH_BUTTON_SIZE)
	slideButton.Position = UDim2.new(0, 20, 1, -GameConstants.UI.TOUCH_BUTTON_SIZE - 20)
	slideButton.BackgroundColor3 = Color3.fromRGB(255, 150, 0) -- ì£¼í™©ìƒ‰
	slideButton.BackgroundTransparency = 0.3
	slideButton.TextColor3 = Color3.fromRGB(255, 255, 255)
	slideButton.TextSize = 32
	slideButton.Font = Enum.Font.GothamBold
	slideButton.Text = "â†“\nSLIDE"
	slideButton.TextYAlignment = Enum.TextYAlignment.Center
	slideButton.Parent = self._screenGui
	self._slideButton = slideButton

	-- ë‘¥ê·¼ ëª¨ì„œë¦¬
	local slideCorner = Instance.new("UICorner")
	slideCorner.CornerRadius = UDim.new(0, 12)
	slideCorner.Parent = slideButton

	-- í…Œë‘ë¦¬
	local slideStroke = Instance.new("UIStroke")
	slideStroke.Color = Color3.fromRGB(255, 255, 255)
	slideStroke.Thickness = 2
	slideStroke.Transparency = 0.5
	slideStroke.Parent = slideButton

	-- ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
	jumpButton.MouseButton1Click:Connect(function()
		if self._onJumpCallback then
			self._onJumpCallback()
		end
	end)

	slideButton.MouseButton1Click:Connect(function()
		if self._onSlideCallback then
			self._onSlideCallback()
		end
	end)

	-- ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ (ê²Œì„ ì‹œì‘ ì‹œ í‘œì‹œ)
	jumpButton.Visible = false
	slideButton.Visible = false

	print("[UIController] Mobile controls created")
end

-- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì„¤ì •
function UIController:_setupEventHandlers()
	-- ì ìˆ˜ ì—…ë°ì´íŠ¸
	local scoreConnection = RemoteEvents.ScoreUpdate.OnClientEvent:Connect(function(data)
		self:UpdateScore(data.score, data.distance, data.coins)
	end)
	table.insert(self._connections, scoreConnection)

	-- ë¼ì´í”„ ì—…ë°ì´íŠ¸
	local lifeConnection = RemoteEvents.LifeUpdate.OnClientEvent:Connect(function(data)
		self:UpdateLives(data.lives)
	end)
	table.insert(self._connections, lifeConnection)

	-- ì½”ì¸ ìˆ˜ì§‘
	local coinConnection = RemoteEvents.CoinCollected.OnClientEvent:Connect(function(data)
		self:UpdateCoins(data.totalCoins)
	end)
	table.insert(self._connections, coinConnection)

	-- ê²Œì„ ì˜¤ë²„
	local gameOverConnection = RemoteEvents.GameOver.OnClientEvent:Connect(function(data)
		self:ShowGameOver(data.finalScore, data.earnedCoins, data.highScore, data.distance, data.isNewRecord)
	end)
	table.insert(self._connections, gameOverConnection)

	print("[UIController] Event handlers set up")
end

-- ì ìˆ˜ ì—…ë°ì´íŠ¸
function UIController:UpdateScore(score: number, distance: number, coins: number)
	if self._scoreLabel then
		self._scoreLabel.Text = `Score: {score}`
	end
	if self._distanceLabel then
		self._distanceLabel.Text = `Distance: {distance}m`
	end
end

-- ì½”ì¸ ì—…ë°ì´íŠ¸
function UIController:UpdateCoins(coins: number)
	if self._coinsLabel then
		self._coinsLabel.Text = `ğŸª™ {coins}`
	end
end

-- ë¼ì´í”„ ì—…ë°ì´íŠ¸
function UIController:UpdateLives(lives: number)
	local previousLives = self._currentLives
	self._currentLives = lives

	-- ê°œë³„ í•˜íŠ¸ ì—…ë°ì´íŠ¸
	for i, heart in ipairs(self._heartLabels) do
		if i <= lives then
			-- ì‚´ì•„ìˆëŠ” í•˜íŠ¸
			heart.Text = "â¤ï¸"
			heart.TextTransparency = 0
		else
			-- ìƒì€ í•˜íŠ¸
			heart.Text = "ğŸ–¤"
			heart.TextTransparency = 0.3
		end
	end

	-- ë¼ì´í”„ ê°ì†Œ ì‹œ ì• ë‹ˆë©”ì´ì…˜
	if lives < previousLives and lives > 0 then
		local lostHeartIndex = lives + 1
		if lostHeartIndex <= #self._heartLabels then
			local heart = self._heartLabels[lostHeartIndex]

			-- í•˜íŠ¸ê°€ ì»¤ì¡Œë‹¤ê°€ ì‘ì•„ì§€ëŠ” ì• ë‹ˆë©”ì´ì…˜
			heart.TextSize = 48
			local tweenInfo = TweenInfo.new(0.3, Enum.EasingStyle.Elastic, Enum.EasingDirection.Out)
			local tween = TweenService:Create(heart, tweenInfo, {
				TextSize = 32,
			})
			tween:Play()
		end
	end
end

-- ì í”„ ì½œë°± ì„¤ì •
function UIController:OnJump(callback: () -> ())
	self._onJumpCallback = callback
end

-- ìŠ¬ë¼ì´ë“œ ì½œë°± ì„¤ì •
function UIController:OnSlide(callback: () -> ())
	self._onSlideCallback = callback
end

-- ê²Œì„ ì˜¤ë²„ í™”ë©´ í‘œì‹œ
function UIController:ShowGameOver(finalScore: number, earnedCoins: number, highScore: number?, distance: number?, isNewRecord: boolean?)
	if not self._gameOverFrame then
		return
	end

	-- ìµœì¢… ì ìˆ˜ í‘œì‹œ
	local finalScoreLabel = self._gameOverFrame:FindFirstChild("FinalScore") :: TextLabel?
	if finalScoreLabel then
		finalScoreLabel.Text = `Score: {finalScore}`
	end

	-- ê±°ë¦¬ í‘œì‹œ
	local distanceLabel = self._gameOverFrame:FindFirstChild("Distance") :: TextLabel?
	if distanceLabel then
		distanceLabel.Text = `ğŸƒ Distance: {distance or 0}m`
	end

	local earnedCoinsLabel = self._gameOverFrame:FindFirstChild("EarnedCoins") :: TextLabel?
	if earnedCoinsLabel then
		earnedCoinsLabel.Text = `ğŸª™ Coins: {earnedCoins}`
	end

	-- ìµœê³  ì ìˆ˜ í‘œì‹œ
	local highScoreLabel = self._gameOverFrame:FindFirstChild("HighScore") :: TextLabel?
	if highScoreLabel and highScore then
		highScoreLabel.Text = `ğŸ† High Score: {highScore}`
	end

	-- NEW RECORD í‘œì‹œ
	local newRecordLabel = self._gameOverFrame:FindFirstChild("NewRecord") :: TextLabel?
	if newRecordLabel then
		newRecordLabel.Visible = isNewRecord == true
	end

	-- ê²Œì„ ì˜¤ë²„ í”„ë ˆì„ í‘œì‹œ (ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜)
	self._gameOverFrame.Size = UDim2.new(0, 0, 0, 0)
	self._gameOverFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
	self._gameOverFrame.Visible = true

	local appearTween = TweenService:Create(self._gameOverFrame, TweenInfo.new(0.4, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
		Size = UDim2.new(0, 450, 0, 480),
		Position = UDim2.new(0.5, -225, 0.5, -240),
	})
	appearTween:Play()

	-- NEW RECORD ì• ë‹ˆë©”ì´ì…˜ (ê¹œë¹¡ì„)
	if isNewRecord and newRecordLabel then
		task.spawn(function()
			for i = 1, 6 do
				if not newRecordLabel or not newRecordLabel.Parent then
					break
				end
				newRecordLabel.BackgroundTransparency = 0.5
				task.wait(0.2)
				if not newRecordLabel or not newRecordLabel.Parent then
					break
				end
				newRecordLabel.BackgroundTransparency = 0.1
				task.wait(0.2)
			end
		end)
	end

	print(`[UIController] Game Over displayed - Score: {finalScore}, Coins: {earnedCoins}, Distance: {distance or 0}m, HighScore: {highScore or 0}, NewRecord: {isNewRecord or false}`)
end

-- í”Œë ˆì´ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
function UIController:OnPlayButtonClicked()
	print("[UIController] Play button clicked")

	-- ì‹œì‘ ë©”ë‰´ ìˆ¨ê¸°ê¸°
	self:HideStartMenu()

	-- ì„œë²„ì— ê²Œì„ ì‹œì‘ ìš”ì²­
	RemoteEvents.GameStart:FireServer()
end

-- ì¬ì‹œì‘ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
function UIController:OnRestartButtonClicked()
	print("[UIController] Restart button clicked")

	-- ê²Œì„ ì˜¤ë²„ í™”ë©´ ìˆ¨ê¸°ê¸°
	self:HideGameOver()

	-- ì„œë²„ì— ê²Œì„ ì‹œì‘ ìš”ì²­
	RemoteEvents.GameStart:FireServer()
end

-- ì‹œì‘ ë©”ë‰´ í‘œì‹œ
function UIController:ShowStartMenu()
	if self._startMenuFrame then
		self._startMenuFrame.Visible = true
	end

	-- ê²Œì„ UI ìˆ¨ê¸°ê¸°
	if self._scoreLabel then
		self._scoreLabel.Visible = false
	end
	if self._coinsLabel then
		self._coinsLabel.Visible = false
	end
	if self._livesContainer then
		self._livesContainer.Visible = false
	end
	if self._distanceLabel then
		self._distanceLabel.Visible = false
	end
	if self._jumpButton then
		self._jumpButton.Visible = false
	end
	if self._slideButton then
		self._slideButton.Visible = false
	end
end

-- ì‹œì‘ ë©”ë‰´ ìˆ¨ê¸°ê¸°
function UIController:HideStartMenu()
	if self._startMenuFrame then
		self._startMenuFrame.Visible = false
	end

	-- ê²Œì„ UI í‘œì‹œ
	if self._scoreLabel then
		self._scoreLabel.Visible = true
	end
	if self._coinsLabel then
		self._coinsLabel.Visible = true
	end
	if self._livesContainer then
		self._livesContainer.Visible = true
	end
	if self._distanceLabel then
		self._distanceLabel.Visible = true
	end
	if self._jumpButton then
		self._jumpButton.Visible = true
	end
	if self._slideButton then
		self._slideButton.Visible = true
	end
end

-- ê²Œì„ ì˜¤ë²„ í™”ë©´ ìˆ¨ê¸°ê¸° (ì¬ì‹œì‘ ì‹œ)
function UIController:HideGameOver()
	if self._gameOverFrame then
		self._gameOverFrame.Visible = false

		-- NEW RECORD ìˆ¨ê¸°ê¸°
		local newRecordLabel = self._gameOverFrame:FindFirstChild("NewRecord") :: TextLabel?
		if newRecordLabel then
			newRecordLabel.Visible = false
		end
	end

	-- UI ì´ˆê¸°í™”
	self:UpdateScore(0, 0, 0)
	self:UpdateCoins(0)
	self:UpdateLives(GameConstants.LIFE.STARTING_LIVES)
end

-- íŠœí† ë¦¬ì–¼ ë°°ë„ˆ í‘œì‹œ
function UIController:ShowTutorialBanner()
	if self._tutorialBanner then
		self._tutorialBanner.Visible = true
	end
	print("[UIController] Tutorial banner shown")
end

-- íŠœí† ë¦¬ì–¼ ë°°ë„ˆ ìˆ¨ê¸°ê¸°
function UIController:HideTutorialBanner()
	if self._tutorialBanner then
		self._tutorialBanner.Visible = false
	end
end

-- íŠœí† ë¦¬ì–¼ ì™„ë£Œ ì•Œë¦¼ í‘œì‹œ (ì ì‹œ í›„ ìë™ ìˆ¨ê¹€)
function UIController:ShowTutorialComplete()
	-- ë°°ë„ˆ ìˆ¨ê¸°ê¸°
	self:HideTutorialBanner()

	-- ì™„ë£Œ ì•Œë¦¼ í‘œì‹œ
	if self._tutorialNotification then
		self._tutorialNotification.Visible = true

		-- 2ì´ˆ í›„ ìë™ ìˆ¨ê¹€
		task.delay(2, function()
			if self._tutorialNotification then
				self._tutorialNotification.Visible = false
			end
		end)
	end
	print("[UIController] Tutorial complete notification shown")
end

-- ì¹´ìš´íŠ¸ë‹¤ìš´ í‘œì‹œ (3, 2, 1, ì‹œì‘!)
function UIController:ShowCountdown(onComplete: () -> ())
	if not self._countdownLabel then
		-- ì¹´ìš´íŠ¸ë‹¤ìš´ UI ì—†ìœ¼ë©´ ë°”ë¡œ ì‹œì‘
		if onComplete then
			onComplete()
		end
		return
	end

	local countdownLabel = self._countdownLabel
	countdownLabel.Visible = true

	-- ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œí€€ìŠ¤
	local sequence = {
		{ text = "3", color = Color3.fromRGB(255, 100, 100), duration = 0.8 },
		{ text = "2", color = Color3.fromRGB(255, 200, 100), duration = 0.8 },
		{ text = "1", color = Color3.fromRGB(100, 255, 100), duration = 0.8 },
		{ text = "ì‹œì‘!", color = Color3.fromRGB(100, 200, 255), duration = 0.6 },
	}

	local totalDelay = 0
	for i, step in ipairs(sequence) do
		task.delay(totalDelay, function()
			countdownLabel.Text = step.text
			countdownLabel.TextColor3 = step.color

			-- ë§ˆì§€ë§‰ ìŠ¤í…ì—ì„œ ì½œë°± í˜¸ì¶œ
			if i == #sequence then
				task.delay(step.duration, function()
					countdownLabel.Visible = false
					if onComplete then
						onComplete()
					end
				end)
			end
		end)
		totalDelay += step.duration
	end

	print("[UIController] Countdown started")
end

-- ì •ë¦¬
function UIController:Destroy()
	if self._screenGui then
		self._screenGui:Destroy()
	end

	for _, connection in self._connections do
		connection:Disconnect()
	end
	self._connections = {}
end

return UIController
