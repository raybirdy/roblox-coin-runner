--!strict
-- ScenarioController
-- ì‹œë‚˜ë¦¬ì˜¤ UI: ì±•í„° ëª©ë¡, í€˜ìŠ¤íŠ¸ ì§„í–‰ë°”, ìŠ¤í‚¬ íƒ­, ë¡œë¹„ ë²„íŠ¼

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RemoteEvents = require(ReplicatedStorage.Shared.RemoteEvents)
local ScenarioConstants = require(ReplicatedStorage.Shared.Constants.ScenarioConstants)
local ResponsiveUtil = require(ReplicatedStorage.Shared.Utils.ResponsiveUtil)

local ScenarioController = {}
ScenarioController.__index = ScenarioController

export type ScenarioController = typeof(setmetatable(
	{} :: {
		_player: Player,
		_connections: { RBXScriptConnection },
		-- ë£¨íŠ¸ GUI
		_gui: ScreenGui?,
		_lobbyButton: TextButton?,
		-- ë©”ì¸ íŒì—…
		_panelFrame: Frame?,
		_isOpen: boolean,
		-- íƒ­
		_currentTab: string,
		_tabChapters: TextButton?,
		_tabSkills: TextButton?,
		_chapterScrollFrame: ScrollingFrame?,
		_skillFrame: Frame?,
		-- ì±•í„° ìƒì„¸ ì˜¤ë²„ë ˆì´
		_detailFrame: Frame?,
		_detailTitleLabel: TextLabel?,
		_detailScrollFrame: ScrollingFrame?,
		_currentDetailChapterId: string?,
		-- í€˜ìŠ¤íŠ¸ ì§„í–‰ë„ ë°” ìºì‹œ (questId â†’ fill Frame)
		_questFillBars: { [string]: Frame },
		_questProgressTexts: { [string]: TextLabel },
		-- ì±•í„° ì¹´ë“œ ìºì‹œ (chapterId â†’ card Frame)
		_chapterCards: { [string]: Frame },
		-- ìµœì‹  ì„œë²„ ë°ì´í„°
		_scenarioData: any?,
		-- ê²Œì„ ì¤‘ í€˜ìŠ¤íŠ¸ íŒíŠ¸ HUD
		_questHudGui: ScreenGui?,
		_questHudItems: { { nameLabel: TextLabel, progressFill: Frame, progressText: TextLabel, frame: Frame } },
		_isGameActive: boolean,
		-- ì ê¸ˆ ì±•í„° ì ìˆ˜ ì‹œê°í™”ìš© ìºì‹œ
		_playerHighScore: number,
	},
	ScenarioController
))

function ScenarioController.new(player: Player): ScenarioController
	local self = setmetatable({
		_player = player,
		_connections = {},
		_gui = nil,
		_lobbyButton = nil,
		_panelFrame = nil,
		_isOpen = false,
		_currentTab = "chapters",
		_tabChapters = nil,
		_tabSkills = nil,
		_chapterScrollFrame = nil,
		_skillFrame = nil,
		_detailFrame = nil,
		_detailTitleLabel = nil,
		_detailScrollFrame = nil,
		_currentDetailChapterId = nil,
		_questFillBars = {},
		_questProgressTexts = {},
		_chapterCards = {},
		_scenarioData = nil,
		_questHudGui = nil,
		_questHudItems = {},
		_isGameActive = false,
		_playerHighScore = 0,
	}, ScenarioController)

	self:_createGui()
	self:_setupEventHandlers()

	-- 2ì´ˆ í›„ ì´ˆê¸° ë°ì´í„° ìš”ì²­
	task.delay(2.5, function()
		RemoteEvents.ScenarioDataRequest:FireServer()
	end)

	return self
end

-- ==================== GUI ìƒì„± ====================

function ScenarioController:_createGui()
	local playerGui = self._player:WaitForChild("PlayerGui")

	local gui = Instance.new("ScreenGui")
	gui.Name = "ScenarioGui"
	gui.ResetOnSpawn = false
	gui.DisplayOrder = 17
	gui.Parent = playerGui
	self._gui = gui

	-- ë¡œë¹„ ë²„íŠ¼ (ProgressionGui ë¯¸ì…˜ ë²„íŠ¼ ì˜¤ë¥¸ìª½)
	local lobbyBtn = Instance.new("TextButton")
	lobbyBtn.Name = "ScenarioButton"
	lobbyBtn.Size = UDim2.new(0, 48, 0, 48)
	lobbyBtn.Position = UDim2.new(0, 228, 0, 16)
	lobbyBtn.BackgroundColor3 = Color3.fromRGB(60, 80, 180)
	lobbyBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
	lobbyBtn.TextSize = ResponsiveUtil.scaledTextSize(20, 14)
	lobbyBtn.Font = Enum.Font.GothamBold
	lobbyBtn.Text = "ğŸ“–"
	lobbyBtn.Parent = gui
	self._lobbyButton = lobbyBtn

	local lobbyBtnCorner = Instance.new("UICorner")
	lobbyBtnCorner.CornerRadius = UDim.new(0, 8)
	lobbyBtnCorner.Parent = lobbyBtn

	local lobbyBtnStroke = Instance.new("UIStroke")
	lobbyBtnStroke.Color = Color3.fromRGB(100, 140, 255)
	lobbyBtnStroke.Thickness = 2
	lobbyBtnStroke.Parent = lobbyBtn

	lobbyBtn.MouseButton1Click:Connect(function()
		if self._isOpen then
			self:ClosePanel()
		else
			self:OpenPanel()
		end
	end)

	-- ë©”ì¸ íŒì—… (ë”¤ ë°°ê²½ í¬í•¨)
	local popupGui = Instance.new("ScreenGui")
	popupGui.Name = "ScenarioPopupGui"
	popupGui.ResetOnSpawn = false
	popupGui.DisplayOrder = 18
	popupGui.Enabled = false
	popupGui.Parent = playerGui

	-- ë”¤ ë°°ê²½
	local dimBg = Instance.new("TextButton")
	dimBg.Name = "DimBg"
	dimBg.Size = UDim2.new(1, 0, 1, 0)
	dimBg.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
	dimBg.BackgroundTransparency = 0.5
	dimBg.Text = ""
	dimBg.AutoButtonColor = false
	dimBg.Parent = popupGui

	dimBg.MouseButton1Click:Connect(function()
		self:ClosePanel()
	end)

	-- íŒì—… í”„ë ˆì„
	local frame = Instance.new("Frame")
	frame.Name = "ScenarioFrame"
	frame.Size = ResponsiveUtil.clampedSize(370, 440, 0.92, 0.88)
	frame.Position = ResponsiveUtil.clampedPosition(370, 440, 0.92, 0.88)
	frame.BackgroundColor3 = Color3.fromRGB(18, 22, 38)
	frame.BorderSizePixel = 0
	frame.Parent = popupGui
	self._panelFrame = frame

	-- í”„ë ˆì„ ì €ì¥ (popupGuiëŠ” ë³„ë„ ê´€ë¦¬)
	gui:SetAttribute("PopupGuiName", "ScenarioPopupGui")

	local frameCorner = Instance.new("UICorner")
	frameCorner.CornerRadius = UDim.new(0, 12)
	frameCorner.Parent = frame

	local frameStroke = Instance.new("UIStroke")
	frameStroke.Color = Color3.fromRGB(80, 120, 255)
	frameStroke.Thickness = 2
	frameStroke.Parent = frame

	-- íƒ€ì´í‹€
	local titleLabel = Instance.new("TextLabel")
	titleLabel.Size = UDim2.new(1, -60, 0, 36)
	titleLabel.Position = UDim2.new(0, 16, 0, 8)
	titleLabel.BackgroundTransparency = 1
	titleLabel.TextColor3 = Color3.fromRGB(120, 180, 255)
	titleLabel.TextSize = ResponsiveUtil.scaledTextSize(18, 14)
	titleLabel.Font = Enum.Font.GothamBlack
	titleLabel.Text = "ğŸ“– SCENARIO"
	titleLabel.TextXAlignment = Enum.TextXAlignment.Left
	titleLabel.Parent = frame

	-- ë‹«ê¸° ë²„íŠ¼
	local closeBtn = Instance.new("TextButton")
	closeBtn.Size = UDim2.new(0, 36, 0, 36)
	closeBtn.Position = UDim2.new(1, -44, 0, 8)
	closeBtn.BackgroundColor3 = Color3.fromRGB(80, 40, 40)
	closeBtn.TextColor3 = Color3.fromRGB(255, 150, 150)
	closeBtn.TextSize = 18
	closeBtn.Font = Enum.Font.GothamBold
	closeBtn.Text = "âœ•"
	closeBtn.Parent = frame

	local closeBtnCorner = Instance.new("UICorner")
	closeBtnCorner.CornerRadius = UDim.new(0, 8)
	closeBtnCorner.Parent = closeBtn

	closeBtn.MouseButton1Click:Connect(function()
		self:ClosePanel()
	end)

	-- íƒ­ ë°”
	local tabBar = Instance.new("Frame")
	tabBar.Name = "TabBar"
	tabBar.Size = UDim2.new(1, -20, 0, 32)
	tabBar.Position = UDim2.new(0, 10, 0, 50)
	tabBar.BackgroundColor3 = Color3.fromRGB(12, 14, 25)
	tabBar.BorderSizePixel = 0
	tabBar.Parent = frame

	local tabBarCorner = Instance.new("UICorner")
	tabBarCorner.CornerRadius = UDim.new(0, 8)
	tabBarCorner.Parent = tabBar

	local tabChapters = Instance.new("TextButton")
	tabChapters.Name = "TabChapters"
	tabChapters.Size = UDim2.new(0.5, 0, 1, 0)
	tabChapters.Position = UDim2.new(0, 0, 0, 0)
	tabChapters.BackgroundColor3 = Color3.fromRGB(60, 80, 180)
	tabChapters.TextColor3 = Color3.fromRGB(255, 255, 255)
	tabChapters.TextSize = ResponsiveUtil.scaledTextSize(13, 11)
	tabChapters.Font = Enum.Font.GothamBold
	tabChapters.Text = "ì±•í„°"
	tabChapters.Parent = tabBar
	self._tabChapters = tabChapters

	local tabChaptersCorner = Instance.new("UICorner")
	tabChaptersCorner.CornerRadius = UDim.new(0, 8)
	tabChaptersCorner.Parent = tabChapters

	local tabSkills = Instance.new("TextButton")
	tabSkills.Name = "TabSkills"
	tabSkills.Size = UDim2.new(0.5, 0, 1, 0)
	tabSkills.Position = UDim2.new(0.5, 0, 0, 0)
	tabSkills.BackgroundColor3 = Color3.fromRGB(35, 35, 55)
	tabSkills.TextColor3 = Color3.fromRGB(180, 180, 200)
	tabSkills.TextSize = ResponsiveUtil.scaledTextSize(13, 11)
	tabSkills.Font = Enum.Font.GothamBold
	tabSkills.Text = "ìŠ¤í‚¬"
	tabSkills.Parent = tabBar
	self._tabSkills = tabSkills

	local tabSkillsCorner = Instance.new("UICorner")
	tabSkillsCorner.CornerRadius = UDim.new(0, 8)
	tabSkillsCorner.Parent = tabSkills

	tabChapters.MouseButton1Click:Connect(function()
		self:_switchTab("chapters")
	end)
	tabSkills.MouseButton1Click:Connect(function()
		self:_switchTab("skills")
	end)

	-- ì±•í„° ìŠ¤í¬ë¡¤ í”„ë ˆì„
	local chapterScroll = Instance.new("ScrollingFrame")
	chapterScroll.Name = "ChapterScroll"
	chapterScroll.Size = UDim2.new(1, -10, 1, -92)
	chapterScroll.Position = UDim2.new(0, 5, 0, 88)
	chapterScroll.BackgroundTransparency = 1
	chapterScroll.ScrollBarThickness = 4
	chapterScroll.ScrollBarImageColor3 = Color3.fromRGB(80, 120, 255)
	chapterScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
	chapterScroll.Visible = true
	chapterScroll.Parent = frame
	self._chapterScrollFrame = chapterScroll

	-- ì±•í„° ì¹´ë“œë¥¼ ë‹´ì„ UIListLayout
	local listLayout = Instance.new("UIListLayout")
	listLayout.SortOrder = Enum.SortOrder.LayoutOrder
	listLayout.Padding = UDim.new(0, 6)
	listLayout.Parent = chapterScroll

	listLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
		chapterScroll.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y + 10)
	end)

	-- ì±•í„° ì¹´ë“œ 10ê°œ ë¯¸ë¦¬ ìƒì„±
	self:_buildChapterCards(chapterScroll)

	-- ìŠ¤í‚¬ í”„ë ˆì„
	local skillFrame = Instance.new("Frame")
	skillFrame.Name = "SkillFrame"
	skillFrame.Size = UDim2.new(1, -10, 1, -92)
	skillFrame.Position = UDim2.new(0, 5, 0, 88)
	skillFrame.BackgroundTransparency = 1
	skillFrame.Visible = false
	skillFrame.Parent = frame
	self._skillFrame = skillFrame

	self:_buildSkillCards(skillFrame)

	-- ì±•í„° ìƒì„¸ ì˜¤ë²„ë ˆì´ (ì±•í„° ì¹´ë“œ í´ë¦­ ì‹œ)
	self:_buildDetailOverlay(frame)

	-- ê²Œì„ ì¤‘ í€˜ìŠ¤íŠ¸ íŒíŠ¸ HUD
	self:_createQuestHud()
end

-- ==================== ê²Œì„ ì¤‘ í€˜ìŠ¤íŠ¸ íŒíŠ¸ HUD ====================

function ScenarioController:_createQuestHud()
	local playerGui = self._player:WaitForChild("PlayerGui")

	local hudGui = Instance.new("ScreenGui")
	hudGui.Name = "QuestHudGui"
	hudGui.ResetOnSpawn = false
	hudGui.DisplayOrder = 15
	hudGui.Enabled = false
	hudGui.Parent = playerGui
	self._questHudGui = hudGui

	local panel = Instance.new("Frame")
	panel.Name = "QuestHudPanel"
	panel.Size = UDim2.new(0, 205, 0, 88)
	panel.Position = UDim2.new(0, 8, 0, 160)
	panel.BackgroundColor3 = Color3.fromRGB(10, 12, 22)
	panel.BackgroundTransparency = 0.2
	panel.BorderSizePixel = 0
	panel.Parent = hudGui

	local panelCorner = Instance.new("UICorner")
	panelCorner.CornerRadius = UDim.new(0, 10)
	panelCorner.Parent = panel

	local panelStroke = Instance.new("UIStroke")
	panelStroke.Color = Color3.fromRGB(80, 120, 255)
	panelStroke.Thickness = 1
	panelStroke.Parent = panel

	local titleLabel = Instance.new("TextLabel")
	titleLabel.Size = UDim2.new(1, -8, 0, 18)
	titleLabel.Position = UDim2.new(0, 8, 0, 4)
	titleLabel.BackgroundTransparency = 1
	titleLabel.TextColor3 = Color3.fromRGB(140, 170, 255)
	titleLabel.TextSize = 11
	titleLabel.Font = Enum.Font.GothamBold
	titleLabel.Text = "ğŸ¯ í˜„ì¬ í€˜ìŠ¤íŠ¸"
	titleLabel.TextXAlignment = Enum.TextXAlignment.Left
	titleLabel.Parent = panel

	self._questHudItems = {}
	for i = 1, 2 do
		local itemFrame = Instance.new("Frame")
		itemFrame.Name = `QuestHudItem{i}`
		itemFrame.Size = UDim2.new(1, -12, 0, 28)
		itemFrame.Position = UDim2.new(0, 6, 0, 24 + (i - 1) * 31)
		itemFrame.BackgroundColor3 = Color3.fromRGB(20, 25, 48)
		itemFrame.BackgroundTransparency = 0.2
		itemFrame.BorderSizePixel = 0
		itemFrame.Parent = panel

		local itemCorner = Instance.new("UICorner")
		itemCorner.CornerRadius = UDim.new(0, 6)
		itemCorner.Parent = itemFrame

		local nameLabel = Instance.new("TextLabel")
		nameLabel.Name = "NameLabel"
		nameLabel.Size = UDim2.new(1, -58, 0, 14)
		nameLabel.Position = UDim2.new(0, 6, 0, 2)
		nameLabel.BackgroundTransparency = 1
		nameLabel.TextColor3 = Color3.fromRGB(210, 215, 235)
		nameLabel.TextSize = 10
		nameLabel.Font = Enum.Font.GothamBold
		nameLabel.Text = ""
		nameLabel.TextXAlignment = Enum.TextXAlignment.Left
		nameLabel.TextTruncate = Enum.TextTruncate.AtEnd
		nameLabel.Parent = itemFrame

		local progressText = Instance.new("TextLabel")
		progressText.Name = "ProgressText"
		progressText.Size = UDim2.new(0, 52, 0, 14)
		progressText.Position = UDim2.new(1, -54, 0, 2)
		progressText.BackgroundTransparency = 1
		progressText.TextColor3 = Color3.fromRGB(160, 190, 255)
		progressText.TextSize = 10
		progressText.Font = Enum.Font.Gotham
		progressText.Text = ""
		progressText.TextXAlignment = Enum.TextXAlignment.Right
		progressText.Parent = itemFrame

		local progBg = Instance.new("Frame")
		progBg.Name = "ProgBg"
		progBg.Size = UDim2.new(1, -12, 0, 6)
		progBg.Position = UDim2.new(0, 6, 1, -8)
		progBg.BackgroundColor3 = Color3.fromRGB(30, 35, 60)
		progBg.Parent = itemFrame

		local progBgCorner = Instance.new("UICorner")
		progBgCorner.CornerRadius = UDim.new(0, 3)
		progBgCorner.Parent = progBg

		local progFill = Instance.new("Frame")
		progFill.Name = "ProgFill"
		progFill.Size = UDim2.new(0, 0, 1, 0)
		progFill.BackgroundColor3 = Color3.fromRGB(100, 160, 255)
		progFill.Parent = progBg

		local progFillCorner = Instance.new("UICorner")
		progFillCorner.CornerRadius = UDim.new(0, 3)
		progFillCorner.Parent = progFill

		table.insert(self._questHudItems, {
			frame = itemFrame,
			nameLabel = nameLabel,
			progressText = progressText,
			progressFill = progFill,
		})
	end
end

function ScenarioController:_updateQuestHud()
	local hudGui = self._questHudGui
	if not hudGui or not self._isGameActive or not self._scenarioData then
		if hudGui then
			hudGui.Enabled = false
		end
		return
	end

	-- í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì±•í„° ì°¾ê¸° (í•´ê¸ˆë¨ + ë¯¸ì™„ë£Œ, ê°€ì¥ ë‚®ì€ ì±•í„° ë²ˆí˜¸)
	local activeChapter: any? = nil
	local activeChapterNum = math.huge
	local chapters = self._scenarioData.chapters :: { any }
	for _, ch in chapters do
		if ch.isUnlocked and not ch.isCompleted then
			local chDef = ScenarioConstants.CHAPTER_MAP[ch.id]
			local num = chDef and chDef.num or 99
			if num < activeChapterNum then
				activeChapterNum = num
				activeChapter = ch
			end
		end
	end

	if not activeChapter then
		hudGui.Enabled = false
		return
	end

	-- ë¯¸ì™„ë£Œ í€˜ìŠ¤íŠ¸ ì¤‘ ì§„í–‰ë„ ë†’ì€ ìˆœìœ¼ë¡œ ìµœëŒ€ 2ê°œ ì„ íƒ
	local inProgress: { { questData: any, progress: number, target: number } } = {}
	for _, q in activeChapter.quests do
		local questDef = ScenarioConstants.QUESTS[q.id]
		if questDef and not q.completed then
			table.insert(inProgress, {
				questData = questDef,
				progress = q.progress or 0,
				target = questDef.target,
			})
		end
	end

	table.sort(inProgress, function(a, b)
		return (a.progress / a.target) > (b.progress / b.target)
	end)

	hudGui.Enabled = #inProgress > 0
	for i, item in self._questHudItems do
		if inProgress[i] then
			local q = inProgress[i]
			item.frame.Visible = true
			item.nameLabel.Text = q.questData.name
			item.progressText.Text = `{q.progress}/{q.target}`
			local ratio = math.clamp(q.progress / q.target, 0, 1)
			TweenService:Create(item.progressFill, TweenInfo.new(0.4), {
				Size = UDim2.new(ratio, 0, 1, 0),
			}):Play()
		else
			item.frame.Visible = false
		end
	end
end

-- ==================== ì±•í„° ì¹´ë“œ ë¹Œë“œ ====================

function ScenarioController:_buildChapterCards(parent: ScrollingFrame)
	for i, chapter in ScenarioConstants.CHAPTERS do
		local card = Instance.new("Frame")
		card.Name = `Chapter_{chapter.id}`
		card.Size = UDim2.new(1, -8, 0, 68)
		card.BackgroundColor3 = Color3.fromRGB(25, 30, 50)
		card.BorderSizePixel = 0
		card.LayoutOrder = i
		card.Parent = parent
		self._chapterCards[chapter.id] = card

		local cardCorner = Instance.new("UICorner")
		cardCorner.CornerRadius = UDim.new(0, 10)
		cardCorner.Parent = card

		local cardStroke = Instance.new("UIStroke")
		cardStroke.Color = Color3.fromRGB(50, 60, 100)
		cardStroke.Thickness = 1
		cardStroke.Parent = card

		-- í…Œë§ˆ ì´ëª¨ì§€ + ë²ˆí˜¸
		local themeLabel = Instance.new("TextLabel")
		themeLabel.Name = "ThemeLabel"
		themeLabel.Size = UDim2.new(0, 44, 0, 44)
		themeLabel.Position = UDim2.new(0, 8, 0, 12)
		themeLabel.BackgroundColor3 = Color3.fromRGB(35, 40, 65)
		themeLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
		themeLabel.TextSize = 22
		themeLabel.Font = Enum.Font.GothamBold
		themeLabel.Text = chapter.theme
		themeLabel.Parent = card

		local themeCorner = Instance.new("UICorner")
		themeCorner.CornerRadius = UDim.new(0, 8)
		themeCorner.Parent = themeLabel

		-- ì±•í„° ì´ë¦„
		local nameLabel = Instance.new("TextLabel")
		nameLabel.Name = "NameLabel"
		nameLabel.Size = UDim2.new(1, -130, 0, 22)
		nameLabel.Position = UDim2.new(0, 60, 0, 10)
		nameLabel.BackgroundTransparency = 1
		nameLabel.TextColor3 = Color3.fromRGB(220, 220, 240)
		nameLabel.TextSize = ResponsiveUtil.scaledTextSize(14, 12)
		nameLabel.Font = Enum.Font.GothamBold
		nameLabel.Text = `CH{chapter.num} {chapter.name}`
		nameLabel.TextXAlignment = Enum.TextXAlignment.Left
		nameLabel.Parent = card

		-- ìƒíƒœ ë¼ë²¨ (ì ê¹€/ì§„í–‰ì¤‘/ì™„ë£Œ)
		local statusLabel = Instance.new("TextLabel")
		statusLabel.Name = "StatusLabel"
		statusLabel.Size = UDim2.new(0, 60, 0, 20)
		statusLabel.Position = UDim2.new(1, -68, 0, 10)
		statusLabel.BackgroundTransparency = 1
		statusLabel.TextColor3 = Color3.fromRGB(180, 180, 200)
		statusLabel.TextSize = ResponsiveUtil.scaledTextSize(12, 10)
		statusLabel.Font = Enum.Font.GothamBold
		statusLabel.Text = "ğŸ”’"
		statusLabel.TextXAlignment = Enum.TextXAlignment.Right
		statusLabel.Parent = card

		-- í€˜ìŠ¤íŠ¸ ì§„í–‰ ë°” ë°°ê²½
		local progressBg = Instance.new("Frame")
		progressBg.Name = "ProgressBg"
		progressBg.Size = UDim2.new(1, -68, 0, 8)
		progressBg.Position = UDim2.new(0, 60, 0, 38)
		progressBg.BackgroundColor3 = Color3.fromRGB(30, 35, 55)
		progressBg.Parent = card

		local progressBgCorner = Instance.new("UICorner")
		progressBgCorner.CornerRadius = UDim.new(0, 4)
		progressBgCorner.Parent = progressBg

		local progressFill = Instance.new("Frame")
		progressFill.Name = "ProgressFill"
		progressFill.Size = UDim2.new(0, 0, 1, 0)
		progressFill.BackgroundColor3 = Color3.fromRGB(80, 120, 255)
		progressFill.Parent = progressBg

		local progressFillCorner = Instance.new("UICorner")
		progressFillCorner.CornerRadius = UDim.new(0, 4)
		progressFillCorner.Parent = progressFill

		-- í€˜ìŠ¤íŠ¸ ì¹´ìš´íŠ¸ í…ìŠ¤íŠ¸
		local questCount = Instance.new("TextLabel")
		questCount.Name = "QuestCount"
		questCount.Size = UDim2.new(0, 60, 0, 18)
		questCount.Position = UDim2.new(1, -68, 0, 32)
		questCount.BackgroundTransparency = 1
		questCount.TextColor3 = Color3.fromRGB(150, 160, 200)
		questCount.TextSize = ResponsiveUtil.scaledTextSize(11, 9)
		questCount.Font = Enum.Font.Gotham
		questCount.Text = `0/{#chapter.questIds}`
		questCount.TextXAlignment = Enum.TextXAlignment.Right
		questCount.Parent = card

		-- í´ë¦­ â†’ ì±•í„° ìƒì„¸ ì—´ê¸°
		local clickBtn = Instance.new("TextButton")
		clickBtn.Size = UDim2.new(1, 0, 1, 0)
		clickBtn.BackgroundTransparency = 1
		clickBtn.Text = ""
		clickBtn.Parent = card

		clickBtn.MouseButton1Click:Connect(function()
			self:_openChapterDetail(chapter.id)
		end)
	end
end

-- ==================== ìŠ¤í‚¬ ì¹´ë“œ ë¹Œë“œ ====================

function ScenarioController:_buildSkillCards(parent: Frame)
	local yOffset = 8
	for _, skillId in ScenarioConstants.SKILL_ORDER do
		local skill = ScenarioConstants.SKILLS[skillId]
		if not skill then
			continue
		end

		local card = Instance.new("Frame")
		card.Name = `Skill_{skillId}`
		card.Size = UDim2.new(1, -10, 0, 62)
		card.Position = UDim2.new(0, 5, 0, yOffset)
		card.BackgroundColor3 = Color3.fromRGB(25, 25, 45)
		card.BorderSizePixel = 0
		card.Parent = parent

		local cardCorner = Instance.new("UICorner")
		cardCorner.CornerRadius = UDim.new(0, 10)
		cardCorner.Parent = card

		local cardStroke = Instance.new("UIStroke")
		cardStroke.Name = "SkillStroke"
		cardStroke.Color = Color3.fromRGB(50, 50, 80)
		cardStroke.Thickness = 1.5
		cardStroke.Parent = card

		-- ì•„ì´ì½˜
		local iconLabel = Instance.new("TextLabel")
		iconLabel.Size = UDim2.new(0, 44, 0, 44)
		iconLabel.Position = UDim2.new(0, 8, 0, 9)
		iconLabel.BackgroundColor3 = Color3.fromRGB(35, 35, 60)
		iconLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
		iconLabel.TextSize = 22
		iconLabel.Font = Enum.Font.GothamBold
		iconLabel.Text = skill.icon
		iconLabel.Parent = card

		local iconCorner = Instance.new("UICorner")
		iconCorner.CornerRadius = UDim.new(0, 8)
		iconCorner.Parent = iconLabel

		-- ìŠ¤í‚¬ ì´ë¦„
		local nameLabel = Instance.new("TextLabel")
		nameLabel.Name = "SkillName"
		nameLabel.Size = UDim2.new(1, -110, 0, 20)
		nameLabel.Position = UDim2.new(0, 60, 0, 10)
		nameLabel.BackgroundTransparency = 1
		nameLabel.TextColor3 = Color3.fromRGB(220, 220, 240)
		nameLabel.TextSize = ResponsiveUtil.scaledTextSize(13, 11)
		nameLabel.Font = Enum.Font.GothamBold
		nameLabel.Text = skill.name
		nameLabel.TextXAlignment = Enum.TextXAlignment.Left
		nameLabel.Parent = card

		-- ì„¤ëª…
		local descLabel = Instance.new("TextLabel")
		descLabel.Name = "SkillDesc"
		descLabel.Size = UDim2.new(1, -110, 0, 28)
		descLabel.Position = UDim2.new(0, 60, 0, 30)
		descLabel.BackgroundTransparency = 1
		descLabel.TextColor3 = Color3.fromRGB(150, 155, 180)
		descLabel.TextSize = ResponsiveUtil.scaledTextSize(11, 9)
		descLabel.Font = Enum.Font.Gotham
		descLabel.Text = skill.desc
		descLabel.TextXAlignment = Enum.TextXAlignment.Left
		descLabel.TextWrapped = true
		descLabel.Parent = card

		-- ì±•í„° í•´ê¸ˆ ë±ƒì§€
		local chBadge = Instance.new("TextLabel")
		chBadge.Name = "ChBadge"
		chBadge.Size = UDim2.new(0, 80, 0, 24)
		chBadge.Position = UDim2.new(1, -88, 0, 19)
		chBadge.BackgroundColor3 = Color3.fromRGB(40, 50, 90)
		chBadge.TextColor3 = Color3.fromRGB(150, 160, 210)
		chBadge.TextSize = ResponsiveUtil.scaledTextSize(11, 9)
		chBadge.Font = Enum.Font.Gotham
		chBadge.Text = `CH{skill.unlockChapter} í•´ê¸ˆ`
		chBadge.Parent = card

		local chBadgeCorner = Instance.new("UICorner")
		chBadgeCorner.CornerRadius = UDim.new(0, 6)
		chBadgeCorner.Parent = chBadge

		yOffset += 68
	end
end

-- ==================== ì±•í„° ìƒì„¸ ì˜¤ë²„ë ˆì´ ====================

function ScenarioController:_buildDetailOverlay(parent: Frame)
	local detail = Instance.new("Frame")
	detail.Name = "ChapterDetail"
	detail.Size = UDim2.new(1, 0, 1, 0)
	detail.BackgroundColor3 = Color3.fromRGB(18, 22, 38)
	detail.Visible = false
	detail.ZIndex = 5
	detail.Parent = parent
	self._detailFrame = detail

	local detailCorner = Instance.new("UICorner")
	detailCorner.CornerRadius = UDim.new(0, 12)
	detailCorner.Parent = detail

	-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼
	local backBtn = Instance.new("TextButton")
	backBtn.Size = UDim2.new(0, 72, 0, 32)
	backBtn.Position = UDim2.new(0, 10, 0, 8)
	backBtn.BackgroundColor3 = Color3.fromRGB(35, 45, 80)
	backBtn.TextColor3 = Color3.fromRGB(180, 200, 255)
	backBtn.TextSize = ResponsiveUtil.scaledTextSize(13, 11)
	backBtn.Font = Enum.Font.GothamBold
	backBtn.Text = "â—€ ë’¤ë¡œ"
	backBtn.ZIndex = 6
	backBtn.Parent = detail

	local backCorner = Instance.new("UICorner")
	backCorner.CornerRadius = UDim.new(0, 8)
	backCorner.Parent = backBtn

	backBtn.MouseButton1Click:Connect(function()
		self:_closeChapterDetail()
	end)

	-- ì±•í„° íƒ€ì´í‹€
	local titleLabel = Instance.new("TextLabel")
	titleLabel.Name = "DetailTitle"
	titleLabel.Size = UDim2.new(1, -20, 0, 32)
	titleLabel.Position = UDim2.new(0, 10, 0, 46)
	titleLabel.BackgroundTransparency = 1
	titleLabel.TextColor3 = Color3.fromRGB(200, 220, 255)
	titleLabel.TextSize = ResponsiveUtil.scaledTextSize(15, 12)
	titleLabel.Font = Enum.Font.GothamBold
	titleLabel.Text = ""
	titleLabel.TextXAlignment = Enum.TextXAlignment.Left
	titleLabel.ZIndex = 6
	titleLabel.Parent = detail
	self._detailTitleLabel = titleLabel

	-- í€˜ìŠ¤íŠ¸ ëª©ë¡ ìŠ¤í¬ë¡¤
	local questScroll = Instance.new("ScrollingFrame")
	questScroll.Name = "QuestScroll"
	questScroll.Size = UDim2.new(1, -10, 1, -84)
	questScroll.Position = UDim2.new(0, 5, 0, 80)
	questScroll.BackgroundTransparency = 1
	questScroll.ScrollBarThickness = 4
	questScroll.ScrollBarImageColor3 = Color3.fromRGB(80, 120, 255)
	questScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
	questScroll.ZIndex = 6
	questScroll.Parent = detail
	self._detailScrollFrame = questScroll

	local questListLayout = Instance.new("UIListLayout")
	questListLayout.SortOrder = Enum.SortOrder.LayoutOrder
	questListLayout.Padding = UDim.new(0, 6)
	questListLayout.Parent = questScroll

	questListLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
		questScroll.CanvasSize = UDim2.new(0, 0, 0, questListLayout.AbsoluteContentSize.Y + 10)
	end)
end

-- ==================== ì±•í„° ìƒì„¸ ì—´ê¸°/ë‹«ê¸° ====================

function ScenarioController:_openChapterDetail(chapterId: string)
	local detail = self._detailFrame
	if not detail then
		return
	end

	self._currentDetailChapterId = chapterId
	self:_populateQuestDetail(chapterId)

	detail.Visible = true
	detail.Position = UDim2.new(1, 0, 0, 0) -- ì˜¤ë¥¸ìª½ì—ì„œ ìŠ¬ë¼ì´ë“œ ì¸
	TweenService:Create(detail, TweenInfo.new(0.22, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
		Position = UDim2.new(0, 0, 0, 0),
	}):Play()
end

function ScenarioController:_closeChapterDetail()
	local detail = self._detailFrame
	if not detail then
		return
	end

	TweenService:Create(detail, TweenInfo.new(0.18, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
		Position = UDim2.new(1, 0, 0, 0),
	}):Play()

	task.delay(0.2, function()
		detail.Visible = false
		self._currentDetailChapterId = nil
	end)
end

function ScenarioController:_populateQuestDetail(chapterId: string)
	local questScroll = self._detailScrollFrame
	if not questScroll then
		return
	end

	-- ê¸°ì¡´ í€˜ìŠ¤íŠ¸ ì•„ì´í…œ ì œê±°
	for _, child in questScroll:GetChildren() do
		if child:IsA("Frame") then
			child:Destroy()
		end
	end
	self._questFillBars = {}
	self._questProgressTexts = {}

	-- ì±•í„° ë°ì´í„° ì°¾ê¸°
	local chapter = ScenarioConstants.CHAPTER_MAP[chapterId]
	if not chapter then
		return
	end

	-- íƒ€ì´í‹€ ì—…ë°ì´íŠ¸
	if self._detailTitleLabel then
		self._detailTitleLabel.Text = `{chapter.theme} CH{chapter.num}: {chapter.name}`
	end

	-- í€˜ìŠ¤íŠ¸ ì§„í–‰ë„ ê°€ì ¸ì˜¤ê¸°
	local questProgress: { [string]: number } = {}
	if self._scenarioData then
		local chapters = self._scenarioData.chapters :: { any }
		for _, ch in chapters do
			if ch.id == chapterId then
				for _, q in ch.quests do
					questProgress[q.id] = q.progress or 0
				end
				break
			end
		end
	end

	-- ì±•í„° ì ê¸ˆ ì—¬ë¶€
	local isUnlocked = false
	local isCompleted = false
	if self._scenarioData then
		local chapters = self._scenarioData.chapters :: { any }
		for _, ch in chapters do
			if ch.id == chapterId then
				isUnlocked = ch.isUnlocked == true
				isCompleted = ch.isCompleted == true
				break
			end
		end
	end

	-- í€˜ìŠ¤íŠ¸ ì•„ì´í…œ ìƒì„±
	for i, questId in chapter.questIds do
		local quest = ScenarioConstants.QUESTS[questId]
		if not quest then
			continue
		end

		local progress = questProgress[questId] or 0
		local completed = progress >= quest.target

		local item = Instance.new("Frame")
		item.Name = `Quest_{questId}`
		item.Size = UDim2.new(1, -8, 0, 60)
		item.BackgroundColor3 = if completed
			then Color3.fromRGB(28, 32, 18)
			else Color3.fromRGB(22, 26, 44)
		item.BorderSizePixel = 0
		item.LayoutOrder = i
		item.ZIndex = 7
		item.Parent = questScroll

		local itemCorner = Instance.new("UICorner")
		itemCorner.CornerRadius = UDim.new(0, 8)
		itemCorner.Parent = item

		local itemStroke = Instance.new("UIStroke")
		itemStroke.Color = if completed then Color3.fromRGB(80, 140, 60) else Color3.fromRGB(40, 50, 80)
		itemStroke.Thickness = 1
		itemStroke.Parent = item

		-- í€˜ìŠ¤íŠ¸ ì´ë¦„
		local qNameLabel = Instance.new("TextLabel")
		qNameLabel.Size = UDim2.new(1, -70, 0, 20)
		qNameLabel.Position = UDim2.new(0, 10, 0, 6)
		qNameLabel.BackgroundTransparency = 1
		qNameLabel.TextColor3 = if completed then Color3.fromRGB(140, 220, 100) else Color3.fromRGB(210, 215, 235)
		qNameLabel.TextSize = ResponsiveUtil.scaledTextSize(13, 11)
		qNameLabel.Font = Enum.Font.GothamBold
		qNameLabel.Text = quest.name
		qNameLabel.TextXAlignment = Enum.TextXAlignment.Left
		qNameLabel.ZIndex = 7
		qNameLabel.Parent = item

		-- ë³´ìƒ ë¼ë²¨
		local rewardLabel = Instance.new("TextLabel")
		rewardLabel.Size = UDim2.new(0, 65, 0, 20)
		rewardLabel.Position = UDim2.new(1, -70, 0, 6)
		rewardLabel.BackgroundTransparency = 1
		rewardLabel.TextColor3 = Color3.fromRGB(255, 200, 80)
		rewardLabel.TextSize = ResponsiveUtil.scaledTextSize(11, 9)
		rewardLabel.Font = Enum.Font.Gotham
		rewardLabel.Text = `+{quest.reward.coins}ğŸª™`
		rewardLabel.TextXAlignment = Enum.TextXAlignment.Right
		rewardLabel.ZIndex = 7
		rewardLabel.Parent = item

		-- í€˜ìŠ¤íŠ¸ ì„¤ëª…
		local qDescLabel = Instance.new("TextLabel")
		qDescLabel.Size = UDim2.new(1, -20, 0, 14)
		qDescLabel.Position = UDim2.new(0, 10, 0, 26)
		qDescLabel.BackgroundTransparency = 1
		qDescLabel.TextColor3 = Color3.fromRGB(140, 145, 170)
		qDescLabel.TextSize = ResponsiveUtil.scaledTextSize(11, 9)
		qDescLabel.Font = Enum.Font.Gotham
		qDescLabel.Text = quest.desc
		qDescLabel.TextXAlignment = Enum.TextXAlignment.Left
		qDescLabel.ZIndex = 7
		qDescLabel.Parent = item

		-- ì§„í–‰ë„ ë°”
		local qProgBg = Instance.new("Frame")
		qProgBg.Size = UDim2.new(1, -20, 0, 8)
		qProgBg.Position = UDim2.new(0, 10, 0, 44)
		qProgBg.BackgroundColor3 = Color3.fromRGB(30, 35, 58)
		qProgBg.ZIndex = 7
		qProgBg.Parent = item

		local qProgBgCorner = Instance.new("UICorner")
		qProgBgCorner.CornerRadius = UDim.new(0, 4)
		qProgBgCorner.Parent = qProgBg

		local ratio = math.clamp((progress / quest.target), 0, 1)
		local qProgFill = Instance.new("Frame")
		qProgFill.Name = "QFill"
		qProgFill.Size = UDim2.new(ratio, 0, 1, 0)
		qProgFill.BackgroundColor3 = if completed
			then Color3.fromRGB(100, 200, 80)
			else if isUnlocked then Color3.fromRGB(80, 130, 255) else Color3.fromRGB(60, 65, 90)
		qProgFill.ZIndex = 8
		qProgFill.Parent = qProgBg
		self._questFillBars[questId] = qProgFill

		local qProgFillCorner = Instance.new("UICorner")
		qProgFillCorner.CornerRadius = UDim.new(0, 4)
		qProgFillCorner.Parent = qProgFill

		-- ì§„í–‰ë„ í…ìŠ¤íŠ¸ (ë°” ìœ„)
		local qProgText = Instance.new("TextLabel")
		qProgText.Size = UDim2.new(1, 0, 1, 0)
		qProgText.BackgroundTransparency = 1
		qProgText.TextColor3 = Color3.fromRGB(255, 255, 255)
		qProgText.TextSize = ResponsiveUtil.scaledTextSize(10, 8)
		qProgText.Font = Enum.Font.GothamBold
		qProgText.Text = if completed then "CLEAR!" else `{progress}/{quest.target}`
		qProgText.ZIndex = 9
		qProgText.Parent = qProgBg
		self._questProgressTexts[questId] = qProgText

		-- ì ê¸ˆ í‘œì‹œ
		if not isUnlocked then
			local lockLabel = Instance.new("TextLabel")
			lockLabel.Size = UDim2.new(1, 0, 1, 0)
			lockLabel.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
			lockLabel.BackgroundTransparency = 0.6
			lockLabel.TextColor3 = Color3.fromRGB(160, 160, 180)
			lockLabel.TextSize = 16
			lockLabel.Font = Enum.Font.GothamBold
			lockLabel.Text = "ğŸ”’"
			lockLabel.ZIndex = 10
			lockLabel.Parent = item

			local lockCorner = Instance.new("UICorner")
			lockCorner.CornerRadius = UDim.new(0, 8)
			lockCorner.Parent = lockLabel
		end
	end
end

-- ==================== íƒ­ ì „í™˜ ====================

function ScenarioController:_switchTab(tabName: string)
	self._currentTab = tabName
	local isChapters = tabName == "chapters"

	if self._chapterScrollFrame then
		self._chapterScrollFrame.Visible = isChapters
	end
	if self._skillFrame then
		self._skillFrame.Visible = not isChapters
	end

	if self._tabChapters then
		self._tabChapters.BackgroundColor3 = if isChapters
			then Color3.fromRGB(60, 80, 180)
			else Color3.fromRGB(35, 35, 55)
		self._tabChapters.TextColor3 = if isChapters
			then Color3.fromRGB(255, 255, 255)
			else Color3.fromRGB(180, 180, 200)
	end
	if self._tabSkills then
		self._tabSkills.BackgroundColor3 = if not isChapters
			then Color3.fromRGB(100, 50, 180)
			else Color3.fromRGB(35, 35, 55)
		self._tabSkills.TextColor3 = if not isChapters
			then Color3.fromRGB(255, 255, 255)
			else Color3.fromRGB(180, 180, 200)
	end
end

-- ==================== ë°ì´í„°ë¡œ UI ì—…ë°ì´íŠ¸ ====================

function ScenarioController:_updateWithData(data: any)
	self._scenarioData = data
	local chapters = data.chapters :: { any }
	local unlockedSkills = data.unlockedSkills :: { string }

	-- í•´ê¸ˆ ìŠ¤í‚¬ ì…‹
	local skillSet: { [string]: boolean } = {}
	for _, skillId in unlockedSkills do
		skillSet[skillId] = true
	end

	-- ì±•í„° ì¹´ë“œ ì—…ë°ì´íŠ¸
	for _, chapter in chapters do
		local card = self._chapterCards[chapter.id]
		if not card then
			continue
		end

		local isUnlocked = chapter.isUnlocked == true
		local isCompleted = chapter.isCompleted == true

		-- ì™„ë£Œëœ í€˜ìŠ¤íŠ¸ ìˆ˜ ê³„ì‚°
		local doneCount = 0
		local totalCount = #chapter.quests
		for _, q in chapter.quests do
			if q.completed then
				doneCount += 1
			end
		end

		-- ì¹´ë“œ ë°°ê²½ìƒ‰
		if isCompleted then
			card.BackgroundColor3 = Color3.fromRGB(28, 35, 20)
		elseif isUnlocked then
			card.BackgroundColor3 = Color3.fromRGB(22, 28, 48)
		else
			card.BackgroundColor3 = Color3.fromRGB(18, 20, 32)
		end

		-- ìƒíƒœ ë¼ë²¨
		local statusLabel = card:FindFirstChild("StatusLabel") :: TextLabel?
		if statusLabel then
			statusLabel.Text = if isCompleted then "âœ…" elseif isUnlocked then "â–¶" else "ğŸ”’"
			statusLabel.TextColor3 = if isCompleted
				then Color3.fromRGB(100, 220, 80)
				elseif isUnlocked then Color3.fromRGB(100, 160, 255)
				else Color3.fromRGB(100, 100, 120)
		end

		-- í€˜ìŠ¤íŠ¸ ì¹´ìš´íŠ¸
		local questCount = card:FindFirstChild("QuestCount") :: TextLabel?
		if questCount then
			if not isUnlocked then
				-- ì ê¸ˆ ì±•í„°: í•´ê¸ˆ ìš”êµ¬ ì ìˆ˜ ëŒ€ë¹„ í˜„ì¬ ìµœê³ ì ìˆ˜ í‘œì‹œ
				local chapterDef = ScenarioConstants.CHAPTER_MAP[chapter.id]
				local minScore = chapterDef and chapterDef.unlockConditions and chapterDef.unlockConditions.minScore or 0
				questCount.Text = `ğŸ†{self._playerHighScore}/{minScore}`
				questCount.TextColor3 = Color3.fromRGB(200, 160, 80)
			else
				questCount.Text = `{doneCount}/{totalCount}`
				questCount.TextColor3 = if isCompleted
					then Color3.fromRGB(100, 220, 80)
					else Color3.fromRGB(150, 160, 200)
			end
		end

		-- ì§„í–‰ ë°”
		local progressBg = card:FindFirstChild("ProgressBg") :: Frame?
		if progressBg then
			local fill = progressBg:FindFirstChild("ProgressFill") :: Frame?
			if fill then
				local ratio: number
				if not isUnlocked then
					-- ì ê¸ˆ ì±•í„°: ì ìˆ˜ ì§„í–‰ë„ í‘œì‹œ
					local chapterDef = ScenarioConstants.CHAPTER_MAP[chapter.id]
					local minScore = chapterDef and chapterDef.unlockConditions and chapterDef.unlockConditions.minScore or 0
					ratio = if minScore > 0 then math.clamp(self._playerHighScore / minScore, 0, 1) else 0
				else
					ratio = if totalCount > 0 then math.clamp(doneCount / totalCount, 0, 1) else 0
				end
				TweenService:Create(fill, TweenInfo.new(0.5), {
					Size = UDim2.new(ratio, 0, 1, 0),
				}):Play()
				fill.BackgroundColor3 = if isCompleted
					then Color3.fromRGB(100, 200, 80)
					elseif isUnlocked then Color3.fromRGB(80, 130, 255)
					else Color3.fromRGB(200, 160, 60) -- í™©ê¸ˆìƒ‰: ì ìˆ˜ ì§„í–‰ë„
			end
		end

		-- ì´ë¦„ ë¼ë²¨ ìƒ‰ìƒ
		local nameLabel = card:FindFirstChild("NameLabel") :: TextLabel?
		if nameLabel then
			nameLabel.TextColor3 = if isCompleted
				then Color3.fromRGB(160, 230, 120)
				elseif isUnlocked then Color3.fromRGB(220, 225, 245)
				else Color3.fromRGB(100, 105, 130)
		end
	end

	-- ìŠ¤í‚¬ ì¹´ë“œ ì—…ë°ì´íŠ¸
	local skillFrame = self._skillFrame
	if skillFrame then
		for _, skillId in ScenarioConstants.SKILL_ORDER do
			local skillCard = skillFrame:FindFirstChild(`Skill_{skillId}`) :: Frame?
			if not skillCard then
				continue
			end

			local unlocked = skillSet[skillId] == true
			local stroke = skillCard:FindFirstChild("SkillStroke") :: UIStroke?
			if stroke then
				stroke.Color = if unlocked then Color3.fromRGB(150, 80, 240) else Color3.fromRGB(50, 50, 80)
				stroke.Thickness = if unlocked then 2 else 1
			end

			skillCard.BackgroundColor3 = if unlocked
				then Color3.fromRGB(28, 18, 50)
				else Color3.fromRGB(20, 20, 38)

			local iconLabel = skillCard:FindFirstChild("TextLabel") :: TextLabel?
			if iconLabel then
				iconLabel.TextColor3 = if unlocked
					then Color3.fromRGB(210, 150, 255)
					else Color3.fromRGB(80, 80, 100)
			end

			local skillName = skillCard:FindFirstChild("SkillName") :: TextLabel?
			if skillName then
				skillName.TextColor3 = if unlocked
					then Color3.fromRGB(220, 180, 255)
					else Color3.fromRGB(100, 105, 130)
			end

			local chBadge = skillCard:FindFirstChild("ChBadge") :: TextLabel?
			if chBadge then
				chBadge.BackgroundColor3 = if unlocked
					then Color3.fromRGB(70, 30, 120)
					else Color3.fromRGB(35, 38, 65)
				chBadge.TextColor3 = if unlocked
					then Color3.fromRGB(210, 160, 255)
					else Color3.fromRGB(100, 105, 140)
				chBadge.Text = if unlocked then "âœ… í•´ê¸ˆë¨" else `CH{ScenarioConstants.SKILLS[skillId].unlockChapter} í•´ê¸ˆ`
			end
		end
	end

	-- í˜„ì¬ ìƒì„¸ í˜ì´ì§€ê°€ ì—´ë ¤ ìˆìœ¼ë©´ ê°±ì‹ 
	if self._currentDetailChapterId then
		self:_populateQuestDetail(self._currentDetailChapterId)
	end

	-- ê²Œì„ ì¤‘ì´ë©´ í€˜ìŠ¤íŠ¸ HUD ê°±ì‹ 
	if self._isGameActive then
		self:_updateQuestHud()
	end
end

-- QuestProgressUpdate ì´ë²¤íŠ¸ë¡œ í€˜ìŠ¤íŠ¸ ì§„í–‰ë°” ì‹¤ì‹œê°„ ê°±ì‹ 
function ScenarioController:_onQuestProgressUpdate(_progressData: any)
	if self._isOpen or self._isGameActive then
		-- ë°ì´í„° ë‹¤ì‹œ ìš”ì²­í•˜ì—¬ ì „ì²´ ê°±ì‹  (HUD í¬í•¨)
		RemoteEvents.ScenarioDataRequest:FireServer()
	end
end

-- ==================== íŒì—… ì—´ê¸°/ë‹«ê¸° ====================

function ScenarioController:OpenPanel()
	local playerGui = self._player:WaitForChild("PlayerGui")
	local popupGui = playerGui:FindFirstChild("ScenarioPopupGui") :: ScreenGui?
	local frame = self._panelFrame
	if not popupGui or not frame then
		return
	end

	self._isOpen = true
	popupGui.Enabled = true
	self:_switchTab(self._currentTab)

	-- íŒì—… ì• ë‹ˆë©”ì´ì…˜
	local targetSize = ResponsiveUtil.clampedSize(370, 440, 0.92, 0.88)
	local targetW = targetSize.X.Offset
	frame.Size = UDim2.new(0, targetW, 0, 0)
	frame.Position = UDim2.new(0.5, -targetW / 2, 0.5, 0)

	TweenService:Create(frame, TweenInfo.new(0.25, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
		Size = targetSize,
		Position = ResponsiveUtil.clampedPosition(370, 440, 0.92, 0.88),
	}):Play()

	-- ìµœì‹  ë°ì´í„° ìš”ì²­
	RemoteEvents.ScenarioDataRequest:FireServer()
end

function ScenarioController:ClosePanel()
	local playerGui = self._player:WaitForChild("PlayerGui")
	local popupGui = playerGui:FindFirstChild("ScenarioPopupGui") :: ScreenGui?
	local frame = self._panelFrame
	if not popupGui or not frame then
		return
	end

	self._isOpen = false
	self:_closeChapterDetail()

	local targetSize = ResponsiveUtil.clampedSize(370, 440, 0.92, 0.88)
	local targetW = targetSize.X.Offset
	TweenService:Create(frame, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
		Size = UDim2.new(0, targetW, 0, 0),
		Position = UDim2.new(0.5, -targetW / 2, 0.5, 0),
	}):Play()

	task.delay(0.22, function()
		popupGui.Enabled = false
	end)
end

-- ê²Œì„ ì¤‘ ìˆ¨ê¸°ê¸°
function ScenarioController:HideForGame()
	if self._lobbyButton then
		self._lobbyButton.Visible = false
	end
	if self._isOpen then
		self:ClosePanel()
	end
	-- ê²Œì„ ì¤‘ í€˜ìŠ¤íŠ¸ HUD í™œì„±í™”
	self._isGameActive = true
	self:_updateQuestHud()
end

-- ë¡œë¹„ì—ì„œ í‘œì‹œ
function ScenarioController:ShowInLobby()
	if self._lobbyButton then
		self._lobbyButton.Visible = true
	end
	-- í€˜ìŠ¤íŠ¸ HUD ë¹„í™œì„±í™”
	self._isGameActive = false
	if self._questHudGui then
		self._questHudGui.Enabled = false
	end
end

-- ==================== ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ====================

function ScenarioController:_setupEventHandlers()
	-- ì „ì²´ ì‹œë‚˜ë¦¬ì˜¤ ë°ì´í„° ìˆ˜ì‹ 
	local dataConn = RemoteEvents.ScenarioDataResponse.OnClientEvent:Connect(function(data)
		self:_updateWithData(data)
	end)
	table.insert(self._connections, dataConn)

	-- í€˜ìŠ¤íŠ¸ ì§„í–‰ë„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
	local progressConn = RemoteEvents.QuestProgressUpdate.OnClientEvent:Connect(function(data)
		self:_onQuestProgressUpdate(data)
	end)
	table.insert(self._connections, progressConn)

	-- í€˜ìŠ¤íŠ¸ ì™„ë£Œ í† ìŠ¤íŠ¸ ì•Œë¦¼ (QuestCompleted)
	local questDoneConn = RemoteEvents.QuestCompleted.OnClientEvent:Connect(function(data)
		self:_showQuestCompleteToast(data.questName)
	end)
	table.insert(self._connections, questDoneConn)

	-- í”Œë ˆì´ì–´ ë°ì´í„° ë¡œë“œ â†’ ìµœê³ ì ìˆ˜ ìºì‹œ (ì ê¸ˆ ì±•í„° ì ìˆ˜ ì‹œê°í™”ìš©)
	local playerDataConn = RemoteEvents.PlayerDataLoaded.OnClientEvent:Connect(function(data)
		if data and data.highScore then
			self._playerHighScore = data.highScore
			if self._scenarioData then
				self:_updateWithData(self._scenarioData)
			end
		end
	end)
	table.insert(self._connections, playerDataConn)
end

-- í€˜ìŠ¤íŠ¸ ì™„ë£Œ í† ìŠ¤íŠ¸ (í™”ë©´ ìƒë‹¨)
function ScenarioController:_showQuestCompleteToast(questName: string)
	local gui = self._gui
	if not gui then
		return
	end

	local toast = Instance.new("Frame")
	toast.Size = UDim2.new(0, 260, 0, 44)
	toast.Position = UDim2.new(0.5, -130, 0, -50)
	toast.BackgroundColor3 = Color3.fromRGB(30, 80, 30)
	toast.BorderSizePixel = 0
	toast.Parent = gui

	local toastCorner = Instance.new("UICorner")
	toastCorner.CornerRadius = UDim.new(0, 10)
	toastCorner.Parent = toast

	local toastStroke = Instance.new("UIStroke")
	toastStroke.Color = Color3.fromRGB(80, 200, 80)
	toastStroke.Thickness = 2
	toastStroke.Parent = toast

	local toastLabel = Instance.new("TextLabel")
	toastLabel.Size = UDim2.new(1, -12, 1, 0)
	toastLabel.Position = UDim2.new(0, 8, 0, 0)
	toastLabel.BackgroundTransparency = 1
	toastLabel.TextColor3 = Color3.fromRGB(140, 255, 140)
	toastLabel.TextSize = 14
	toastLabel.Font = Enum.Font.GothamBold
	toastLabel.Text = `âœ… í€˜ìŠ¤íŠ¸ ì™„ë£Œ: {questName}`
	toastLabel.TextXAlignment = Enum.TextXAlignment.Left
	toastLabel.Parent = toast

	-- ìŠ¬ë¼ì´ë“œ ë‹¤ìš´ â†’ ëŒ€ê¸° â†’ ìŠ¬ë¼ì´ë“œ ì—…
	TweenService:Create(toast, TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
		Position = UDim2.new(0.5, -130, 0, 60),
	}):Play()

	task.delay(2.5, function()
		TweenService:Create(toast, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
			Position = UDim2.new(0.5, -130, 0, -50),
		}):Play()
		task.delay(0.3, function()
			toast:Destroy()
		end)
	end)
end

return ScenarioController
