--!strict
-- AsyncBattleService
-- ë¹„ë™ê¸° ë°°í‹€: íƒ€ì¸ì˜ ê¸°ë¡ì— ë„ì „í•˜ëŠ” ê¸°ë¡ ë¹„êµ ëª¨ë“œ

local ReplicatedStorage = game:GetService("ReplicatedStorage")

local RemoteEvents = require(ReplicatedStorage.Shared.RemoteEvents)
local PlayerDataService = require(script.Parent.PlayerDataService)
local RateLimiter = require(ReplicatedStorage.Shared.Utils.RateLimiter)

local AsyncBattleService = {}

type BattleTarget = {
	targetName: string,
	targetScore: number,
}

-- í”Œë ˆì´ì–´ë³„ ë„ì „ íƒ€ê²Ÿ (ê²Œì„ ì‹œì‘ ì „ ë¡œë¹„ì—ì„œ ì„¤ì •ë¨)
local _battleTargets: { [Player]: BattleTarget } = {}

local WIN_REWARD_GEMS = 50

-- ==================== íƒ€ê²Ÿ ê´€ë¦¬ ====================

function AsyncBattleService:SetBattleTarget(player: Player, targetName: string, targetScore: number)
	_battleTargets[player] = { targetName = targetName, targetScore = targetScore }
	print(`[AsyncBattleService] {player.Name} â†’ ë„ì „ íƒ€ê²Ÿ: {targetName} ({targetScore}ì )`)
end

function AsyncBattleService:GetBattleTarget(player: Player): BattleTarget?
	return _battleTargets[player]
end

function AsyncBattleService:ClearBattleTarget(player: Player)
	_battleTargets[player] = nil
end

-- ==================== ê²Œì„ ì¢…ë£Œ ì²˜ë¦¬ ====================

-- GameManager.EndGameì—ì„œ í˜¸ì¶œë¨
function AsyncBattleService:ProcessGameEnd(
	player: Player,
	finalScore: number,
	battleTarget: BattleTarget?
)
	if not battleTarget then
		return
	end

	local won = finalScore >= battleTarget.targetScore
	local reward = 0

	if won then
		reward = WIN_REWARD_GEMS
		PlayerDataService:AddGems(player, reward)
		local newGems = PlayerDataService:GetGems(player)
		RemoteEvents.GemsUpdated:FireClient(player, { gems = newGems })
		print(`[AsyncBattleService] {player.Name} ìŠ¹ë¦¬! {finalScore} >= {battleTarget.targetScore} (+{reward} ğŸ’)`)
	else
		print(`[AsyncBattleService] {player.Name} íŒ¨ë°°. {finalScore} < {battleTarget.targetScore}`)
	end

	RemoteEvents.AsyncBattleResult:FireClient(player, {
		won = won,
		myScore = finalScore,
		targetScore = battleTarget.targetScore,
		targetName = battleTarget.targetName,
		reward = won and reward or nil,
	})
end

-- ==================== ì´ë²¤íŠ¸ ì—°ê²° ====================

function AsyncBattleService:SetupRemoteEvents()
	RemoteEvents.AsyncBattleChallenge.OnServerEvent:Connect(function(player: Player, data: any)
		if not RateLimiter.Check(player, "AsyncBattleChallenge", 5) then
			return
		end
		if type(data) ~= "table" then
			return
		end
		local targetName = data.targetName
		local targetScore = data.targetScore
		if type(targetName) ~= "string" or type(targetScore) ~= "number" then
			return
		end
		-- ìê¸° ìì‹  ë„ì „ ë°©ì§€
		if targetName == player.Name then
			return
		end
		local safeScore = math.clamp(math.floor(targetScore), 1, 9999999)
		self:SetBattleTarget(player, targetName, safeScore)
	end)

	print("[AsyncBattleService] Remote events connected")
end

-- í”Œë ˆì´ì–´ í‡´ì¥ ì‹œ ì •ë¦¬
game.Players.PlayerRemoving:Connect(function(player: Player)
	_battleTargets[player] = nil
end)

print("[AsyncBattleService] Initialized")

return AsyncBattleService
